version: '3.8'

services:
  # cursor-runner Node.js application service
  cursor-runner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cursor-runner
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3001
      # Cursor CLI Configuration
      - CURSOR_CLI_PATH=${CURSOR_CLI_PATH:-cursor}
      - CURSOR_CLI_TIMEOUT=${CURSOR_CLI_TIMEOUT:-300000}
      - CURSOR_CLI_ITERATE_TIMEOUT=${CURSOR_CLI_ITERATE_TIMEOUT:-60000}
      - CURSOR_API_KEY=${CURSOR_API_KEY:-}
      # Target Application (jarek-va) - mounted as volume
      # Note: Update this path to point to your jarek-va directory
      - TARGET_APP_PATH=/app/target/jarek-va
      - TARGET_APP_TYPE=${TARGET_APP_TYPE:-rails}
      # Git Service Configuration
      - REPOSITORIES_PATH=/app/repositories
      - GIT_COMMAND_TIMEOUT=${GIT_COMMAND_TIMEOUT:-60000}
      # Terminal Service Configuration
      - TERMINAL_COMMAND_TIMEOUT=${TERMINAL_COMMAND_TIMEOUT:-300000}
      - TERMINAL_MAX_OUTPUT_SIZE=${TERMINAL_MAX_OUTPUT_SIZE:-10485760}
      - ALLOWED_TERMINAL_COMMANDS=${ALLOWED_TERMINAL_COMMANDS:-git,cursor,npm,node,bundle,rails,rspec}
      - BLOCKED_TERMINAL_COMMANDS=${BLOCKED_TERMINAL_COMMANDS:-rm,del,format,dd,sudo,su}
      - ENFORCE_COMMAND_WHITELIST=${ENFORCE_COMMAND_WHITELIST:-false}
      # jarek-va Communication (use Docker service name)
      - JAREK_VA_URL=http://app:3000
      - JAREK_VA_API_KEY=${JAREK_VA_API_KEY:-}
    volumes:
      # Mount jarek-va codebase so cursor-runner can access it
      # Update this path to point to your jarek-va directory
      - ../jarek-va:/app/target/jarek-va
      # Mount repositories directory for persistence
      - cursor_runner_repositories:/app/repositories
      # Mount logs for debugging
      - ./logs:/app/logs
      # Mount cursor-cli if available on host (optional)
      # - /usr/local/bin/cursor:/usr/local/bin/cursor:ro
    networks:
      - virtual-assistant-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  cursor_runner_repositories:
    driver: local

networks:
  virtual-assistant-network:
    external: true
    name: virtual-assistant-network

