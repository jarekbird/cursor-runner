services:
  # Redis service - shared by cursor-runner and other services
  redis:
    image: redis:7-alpine
    container_name: virtual-assistant-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - shared_redis_data:/data
    networks:
      - virtual-assistant-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # cursor-runner Node.js application service
  cursor-runner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cursor-runner
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3001
      # Cursor CLI Configuration
      - CURSOR_CLI_PATH=${CURSOR_CLI_PATH:-cursor}
      - CURSOR_CLI_TIMEOUT=${CURSOR_CLI_TIMEOUT:-300000}
      - CURSOR_CLI_ITERATE_TIMEOUT=${CURSOR_CLI_ITERATE_TIMEOUT:-900000}
      - CURSOR_CLI_IDLE_TIMEOUT=${CURSOR_CLI_IDLE_TIMEOUT:-600000}
      - CURSOR_CLI_MAX_CONCURRENT=${CURSOR_CLI_MAX_CONCURRENT:-5}
      - CURSOR_API_KEY=${CURSOR_API_KEY:-}
      # Target Application (cursor) - mounted as volume
      # Note: Update this path to point to your cursor directory
      - TARGET_APP_PATH=/app/target/cursor
      - TARGET_APP_TYPE=${TARGET_APP_TYPE:-rails}
      # Git Service Configuration
      - REPOSITORIES_PATH=/cursor/repositories
      - GIT_COMMAND_TIMEOUT=${GIT_COMMAND_TIMEOUT:-60000}
      # Scripts directory for one-time scripts created by cursor-cli
      - SCRIPTS_PATH=/cursor/scripts
      # Cursor-agents tools directory path
      - CURSOR_AGENTS_TOOLS_PATH=/cursor/tools/cursor-agents
      # Terminal Service Configuration
      - TERMINAL_COMMAND_TIMEOUT=${TERMINAL_COMMAND_TIMEOUT:-300000}
      - TERMINAL_MAX_OUTPUT_SIZE=${TERMINAL_MAX_OUTPUT_SIZE:-10485760}
      # jarek-va Communication
      # JAREK_VA_URL is optional - defaults to Docker network service name (http://app:3000)
      # Override only if using a different URL or running outside Docker
      - JAREK_VA_URL=${JAREK_VA_URL:-http://app:3000}
      - JAREK_VA_API_KEY=${JAREK_VA_API_KEY:-}
      # Webhook secret for callback authentication
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-}
      # OpenAI API Key for GPT review agent (optional)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # ElevenLabs Agent Configuration
      # Feature flag to enable/disable ElevenLabs agent integration
      # When disabled, cursor completion callbacks will not attempt ElevenLabs integration
      - ELEVENLABS_AGENT_ENABLED=${ELEVENLABS_AGENT_ENABLED:-false}
      # Redis Configuration - Use shared Redis instance for cursor-agents MCP server
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      # GitHub Authentication - Required for git operations
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_USERNAME=${GITHUB_USERNAME:-}
      # Gmail MCP Configuration (optional - for Gmail integration)
      # Feature flag to enable/disable Gmail MCP (default: false for safety)
      - ENABLE_GMAIL_MCP=${ENABLE_GMAIL_MCP:-false}
      - GMAIL_CLIENT_ID=${GMAIL_CLIENT_ID:-}
      - GMAIL_CLIENT_SECRET=${GMAIL_CLIENT_SECRET:-}
      - GMAIL_REFRESH_TOKEN=${GMAIL_REFRESH_TOKEN:-}
      - GMAIL_USER_EMAIL=${GMAIL_USER_EMAIL:-}
      - GMAIL_ALLOWED_LABELS=${GMAIL_ALLOWED_LABELS:-}
      # Alternative git credential environment variables (also supported)
      - GIT_TOKEN=${GIT_TOKEN:-}
      - GIT_USERNAME=${GIT_USERNAME:-}
      # Git user identity (optional, for commits)
      - GIT_USER_NAME=${GIT_USER_NAME:-}
      - GIT_USER_EMAIL=${GIT_USER_EMAIL:-}
    volumes:
      # Mount cursor codebase so cursor-runner can access it
      # Update this path to point to your cursor directory
      - ../cursor:/app/target/cursor
      # Mount cursor-agents codebase so cursor-runner can run its MCP server
      # Update this path to point to your cursor-agents directory
      - ../cursor-agents:/app/target/cursor-agents
      # Mount shared cursor volume (contains repositories, tools, and scripts directories)
      - cursor_runner_repositories:/cursor
      # Mount shared SQLite database for cross-service access
      - shared_sqlite_db:/app/shared_db
      # Mount logs for debugging
      - ./logs:/app/logs
      # MCP configuration is created/merged by merge-mcp-config.js during deployment
      # The script copies the merged config to /root/.cursor/mcp.json
      # We don't mount ./mcp.json here to allow the merge script to write the final config
      # Mount cursor-cli if available on host (optional)
      # - /usr/local/bin/cursor:/usr/local/bin/cursor:ro
    networks:
      - virtual-assistant-network
    depends_on:
      redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      # Path-based routing - only route /conversations/api/* to cursor-runner (API endpoints)
      # Higher priority ensures API routes are matched before jarek-va-ui routes
      - "traefik.http.routers.cursor-runner-conversations-api.priority=20"
      - "traefik.http.routers.cursor-runner-conversations-api.rule=Host(`${DOMAIN_NAME:-localhost}`) && PathPrefix(`/conversations/api`)"
      - "traefik.http.routers.cursor-runner-conversations-api.entrypoints=websecure"
      - "traefik.http.routers.cursor-runner-conversations-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.cursor-runner-conversations-api.service=cursor-runner-api"
      # Strip /conversations prefix before forwarding to the service
      # So /conversations/api/list becomes /api/list at cursor-runner
      - "traefik.http.middlewares.cursor-runner-conversations-api-stripprefix.stripprefix.prefixes=/conversations"
      # Security headers middleware
      - "traefik.http.middlewares.cursor-runner-conversations-api-headers.headers.sslredirect=true"
      - "traefik.http.middlewares.cursor-runner-conversations-api-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.cursor-runner-conversations-api-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.cursor-runner-conversations-api-headers.headers.stsPreload=true"
      # Apply both strip prefix and security headers
      - "traefik.http.routers.cursor-runner-conversations-api.middlewares=cursor-runner-conversations-api-stripprefix,cursor-runner-conversations-api-headers"
      # Shared service definition for both routers (same container, same port)
      - "traefik.http.services.cursor-runner-api.loadbalancer.server.port=3001"
      # Path-based routing for agent conversation API endpoints
      # Higher priority (25) ensures agent routes are matched before regular conversation routes
      - "traefik.http.routers.cursor-runner-agent-conversations-api.priority=25"
      - "traefik.http.routers.cursor-runner-agent-conversations-api.rule=Host(`${DOMAIN_NAME:-localhost}`) && PathPrefix(`/agent-conversations/api`)"
      - "traefik.http.routers.cursor-runner-agent-conversations-api.entrypoints=websecure"
      - "traefik.http.routers.cursor-runner-agent-conversations-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.cursor-runner-agent-conversations-api.service=cursor-runner-api"
      # Strip /agent-conversations/api prefix, then rewrite to /api/agent/*
      # So /agent-conversations/api/list becomes /api/agent/list
      # Step 1: Strip /agent-conversations/api â†’ /list
      - "traefik.http.middlewares.cursor-runner-agent-conversations-api-stripprefix.stripprefix.prefixes=/agent-conversations/api"
      # Step 2: Rewrite /list to /api/agent/list
      - "traefik.http.middlewares.cursor-runner-agent-conversations-api-rewrite.replacepathregex.regex=^(.*)"
      - "traefik.http.middlewares.cursor-runner-agent-conversations-api-rewrite.replacepathregex.replacement=/api/agent/$$1"
      # Apply strip prefix, rewrite, and security headers
      - "traefik.http.routers.cursor-runner-agent-conversations-api.middlewares=cursor-runner-agent-conversations-api-stripprefix,cursor-runner-agent-conversations-api-rewrite,cursor-runner-conversations-api-headers"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  # Shared cursor volume (external - created by deployment scripts or manually)
  cursor_runner_repositories:
    external: true
    name: cursor_runner_repositories
  # Shared SQLite database volume accessible by all services
  # Note: This volume is defined here in cursor-runner and referenced as external by other services
  shared_sqlite_db:
    driver: local
    name: shared_sqlite_db
  # Shared Redis data volume accessible by all services
  # Note: This volume is defined here in cursor-runner and referenced as external by other services
  shared_redis_data:
    driver: local
    name: shared_redis_data

networks:
  virtual-assistant-network:
    external: true
    name: virtual-assistant-network

