version: '3.8'

services:
  # cursor-runner Node.js application service
  cursor-runner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cursor-runner
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3001
      # Cursor CLI Configuration
      - CURSOR_CLI_PATH=${CURSOR_CLI_PATH:-cursor}
      - CURSOR_CLI_TIMEOUT=${CURSOR_CLI_TIMEOUT:-300000}
      - CURSOR_CLI_ITERATE_TIMEOUT=${CURSOR_CLI_ITERATE_TIMEOUT:-60000}
      - CURSOR_API_KEY=${CURSOR_API_KEY:-}
      # Target Application (jarek-va) - mounted as volume
      # Note: Update this path to point to your jarek-va directory
      - TARGET_APP_PATH=/app/target/jarek-va
      - TARGET_APP_TYPE=${TARGET_APP_TYPE:-rails}
      # Git Service Configuration
      - REPOSITORIES_PATH=/app/repositories
      - GIT_COMMAND_TIMEOUT=${GIT_COMMAND_TIMEOUT:-60000}
      # Terminal Service Configuration
      - TERMINAL_COMMAND_TIMEOUT=${TERMINAL_COMMAND_TIMEOUT:-300000}
      - TERMINAL_MAX_OUTPUT_SIZE=${TERMINAL_MAX_OUTPUT_SIZE:-10485760}
      # jarek-va Communication
      # JAREK_VA_URL is optional - defaults to Docker network service name (http://app:3000)
      # Override only if using a different URL or running outside Docker
      - JAREK_VA_URL=${JAREK_VA_URL:-http://app:3000}
      - JAREK_VA_API_KEY=${JAREK_VA_API_KEY:-}
      # Webhook secret for callback authentication
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-}
    volumes:
      # Mount jarek-va codebase so cursor-runner can access it
      # Update this path to point to your jarek-va directory
      - ../jarek-va:/app/target/jarek-va
      # Mount repositories directory for persistence
      - cursor_runner_repositories:/app/repositories
      # Mount shared SQLite database for cross-service access
      - shared_sqlite_db:/app/shared_db
      # Mount logs for debugging
      - ./logs:/app/logs
      # Mount cursor-cli if available on host (optional)
      # - /usr/local/bin/cursor:/usr/local/bin/cursor:ro
    networks:
      - virtual-assistant-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  cursor_runner_repositories:
    driver: local
  # Shared SQLite database volume (external reference to jarek-va volume)
  shared_sqlite_db:
    external: true
    name: shared_sqlite_db

networks:
  virtual-assistant-network:
    external: true
    name: virtual-assistant-network

