services:
  # Traefik reverse proxy - foundational service for routing all traffic
  traefik:
    image: traefik:v3.6
    container_name: virtual-assistant-traefik
    restart: unless-stopped
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=virtual-assistant-network"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@${DOMAIN_NAME:-jarekva.com}}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--api.dashboard=false"
      - "--log.level=INFO"
      - "--accesslog=true"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt
    networks:
      - virtual-assistant-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
      - "traefik.http.routers.http-catchall.rule=HostRegexp(`{host:.+}`)"
      - "traefik.http.routers.http-catchall.entrypoints=web"
      - "traefik.http.routers.http-catchall.middlewares=redirect-to-https"
      - "traefik.http.routers.http-catchall.priority=1"

  redis:
    image: redis:7-alpine
    container_name: virtual-assistant-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - shared_redis_data:/data
    networks:
      - virtual-assistant-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # cursor-runner Node.js application service (monorepo build; includes jira-api-mcp-wrapper bundle)
  cursor-runner:
    build:
      # IMPORTANT: build context is the repository root so Docker can copy both
      # `cursor-runner/` and `jira-api-mcp-wrapper/`.
      context: ..
      dockerfile: cursor-runner/Dockerfile.monorepo
    container_name: cursor-runner
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3001
      - CURSOR_CLI_PATH=${CURSOR_CLI_PATH:-cursor}
      - CURSOR_CLI_TIMEOUT=${CURSOR_CLI_TIMEOUT:-300000}
      - CURSOR_CLI_ITERATE_TIMEOUT=${CURSOR_CLI_ITERATE_TIMEOUT:-1800000}
      - CURSOR_CLI_DIAGNOSTIC_TIMEOUT=${CURSOR_CLI_DIAGNOSTIC_TIMEOUT:-2400000}
      - CURSOR_CLI_IDLE_TIMEOUT=${CURSOR_CLI_IDLE_TIMEOUT:-600000}
      - CURSOR_CLI_MAX_CONCURRENT=${CURSOR_CLI_MAX_CONCURRENT:-5}
      - CURSOR_API_KEY=${CURSOR_API_KEY:-}
      - TARGET_APP_PATH=/cursor
      - TARGET_APP_TYPE=${TARGET_APP_TYPE:-rails}
      - GIT_COMMAND_TIMEOUT=${GIT_COMMAND_TIMEOUT:-60000}
      - TERMINAL_COMMAND_TIMEOUT=${TERMINAL_COMMAND_TIMEOUT:-300000}
      - TERMINAL_MAX_OUTPUT_SIZE=${TERMINAL_MAX_OUTPUT_SIZE:-10485760}
      - JAREK_VA_URL=${JAREK_VA_URL:-http://app:3000}
      - JAREK_VA_API_KEY=${JAREK_VA_API_KEY:-}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ELEVENLABS_AGENT_ENABLED=${ELEVENLABS_AGENT_ENABLED:-false}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_USERNAME=${GITHUB_USERNAME:-}
      - ENABLE_GMAIL_MCP=${ENABLE_GMAIL_MCP:-false}
      - GMAIL_CLIENT_ID=${GMAIL_CLIENT_ID:-}
      - GMAIL_CLIENT_SECRET=${GMAIL_CLIENT_SECRET:-}
      - GMAIL_REFRESH_TOKEN=${GMAIL_REFRESH_TOKEN:-}
      - GMAIL_USER_EMAIL=${GMAIL_USER_EMAIL:-}
      - GMAIL_ALLOWED_LABELS=${GMAIL_ALLOWED_LABELS:-}
      - ENABLE_ATLASSIAN_MCP=${ENABLE_ATLASSIAN_MCP:-false}
      - ATLASSIAN_BASE_URL=${ATLASSIAN_BASE_URL:-}
      - ATLASSIAN_USERNAME=${ATLASSIAN_USERNAME:-}
      - ATLASSIAN_EMAIL=${ATLASSIAN_EMAIL:-}
      - ATLASSIAN_API_TOKEN=${ATLASSIAN_API_TOKEN:-}
      - ATLASSIAN_CLOUD_ID=${ATLASSIAN_CLOUD_ID:-}
      # jira-api-mcp-wrapper (direct Jira REST, no OAuth)
      - JIRA_BASE_URL=${JIRA_BASE_URL:-}
      - JIRA_EMAIL=${JIRA_EMAIL:-}
      - JIRA_API_TOKEN=${JIRA_API_TOKEN:-}
      - GIT_TOKEN=${GIT_TOKEN:-}
      - GIT_USERNAME=${GIT_USERNAME:-}
      - GIT_USER_NAME=${GIT_USER_NAME:-}
      - GIT_USER_EMAIL=${GIT_USER_EMAIL:-}
    volumes:
      - ../cursor:/app/target/cursor
      - ../cursor-agents:/app/target/cursor-agents
      # NOTE: jira-api-mcp-wrapper is baked into the image; no host mount required in production.
      - cursor_runner_repositories:/cursor
      - shared_sqlite_db:/app/shared_db
      - ./logs:/app/logs
    networks:
      - virtual-assistant-network
    depends_on:
      traefik:
        condition: service_started
      redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cursor-runner-conversations-api.priority=20"
      - "traefik.http.routers.cursor-runner-conversations-api.rule=HostRegexp(`.*\\..*`) && Host(`${DOMAIN_NAME:-localhost}`) && PathPrefix(`/conversations/api`)"
      - "traefik.http.routers.cursor-runner-conversations-api.entrypoints=websecure"
      - "traefik.http.routers.cursor-runner-conversations-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.cursor-runner-conversations-api.service=cursor-runner-api"
      - "traefik.http.routers.cursor-runner-conversations-api-http.priority=20"
      - "traefik.http.routers.cursor-runner-conversations-api-http.rule=Host(`localhost`) && PathPrefix(`/conversations/api`)"
      - "traefik.http.routers.cursor-runner-conversations-api-http.entrypoints=web"
      - "traefik.http.routers.cursor-runner-conversations-api-http.service=cursor-runner-api"
      - "traefik.http.middlewares.cursor-runner-conversations-api-stripprefix.stripprefix.prefixes=/conversations"
      - "traefik.http.middlewares.cursor-runner-conversations-api-headers.headers.sslredirect=true"
      - "traefik.http.middlewares.cursor-runner-conversations-api-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.cursor-runner-conversations-api-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.cursor-runner-conversations-api-headers.headers.stsPreload=true"
      - "traefik.http.routers.cursor-runner-conversations-api.middlewares=cursor-runner-conversations-api-stripprefix,cursor-runner-conversations-api-headers"
      - "traefik.http.routers.cursor-runner-conversations-api-http.middlewares=cursor-runner-conversations-api-stripprefix"
      - "traefik.http.services.cursor-runner-api.loadbalancer.server.port=3001"
      - "traefik.http.routers.cursor-runner-agent-conversations-api.priority=25"
      - "traefik.http.routers.cursor-runner-agent-conversations-api.rule=Host(`${DOMAIN_NAME:-localhost}`) && PathPrefix(`/agent-conversations/api`)"
      - "traefik.http.routers.cursor-runner-agent-conversations-api.entrypoints=websecure"
      - "traefik.http.routers.cursor-runner-agent-conversations-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.cursor-runner-agent-conversations-api.service=cursor-runner-api"
      - "traefik.http.routers.cursor-runner-agent-conversations-api-http.priority=25"
      - "traefik.http.routers.cursor-runner-agent-conversations-api-http.rule=Host(`localhost`) && PathPrefix(`/agent-conversations/api`)"
      - "traefik.http.routers.cursor-runner-agent-conversations-api-http.entrypoints=web"
      - "traefik.http.routers.cursor-runner-agent-conversations-api-http.service=cursor-runner-api"
      - "traefik.http.middlewares.cursor-runner-agent-conversations-api-stripprefix.stripprefix.prefixes=/agent-conversations/api"
      - "traefik.http.middlewares.cursor-runner-agent-conversations-api-rewrite.replacepathregex.regex=^/(.*)"
      - "traefik.http.middlewares.cursor-runner-agent-conversations-api-rewrite.replacepathregex.replacement=/api/agent/$$1"
      - "traefik.http.routers.cursor-runner-agent-conversations-api.middlewares=cursor-runner-agent-conversations-api-stripprefix,cursor-runner-agent-conversations-api-rewrite,cursor-runner-conversations-api-headers"
      - "traefik.http.routers.cursor-runner-agent-conversations-api-http.middlewares=cursor-runner-agent-conversations-api-stripprefix,cursor-runner-agent-conversations-api-rewrite"
      - "traefik.http.routers.cursor-runner-cursor-execute.priority=30"
      - "traefik.http.routers.cursor-runner-cursor-execute.rule=Host(`${DOMAIN_NAME:-localhost}`) && PathPrefix(`/cursor/execute`)"
      - "traefik.http.routers.cursor-runner-cursor-execute.entrypoints=websecure"
      - "traefik.http.routers.cursor-runner-cursor-execute.tls.certresolver=letsencrypt"
      - "traefik.http.routers.cursor-runner-cursor-execute.service=cursor-runner-api"
      - "traefik.http.routers.cursor-runner-cursor-execute-http.priority=30"
      - "traefik.http.routers.cursor-runner-cursor-execute-http.rule=Host(`localhost`) && PathPrefix(`/cursor/execute`)"
      - "traefik.http.routers.cursor-runner-cursor-execute-http.entrypoints=web"
      - "traefik.http.routers.cursor-runner-cursor-execute-http.service=cursor-runner-api"
      - "traefik.http.routers.cursor-runner-cursor-execute.middlewares=cursor-runner-conversations-api-headers"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  cursor_runner_repositories:
    external: true
    name: cursor_runner_repositories
  shared_sqlite_db:
    driver: local
    name: shared_sqlite_db
  shared_redis_data:
    driver: local
    name: shared_redis_data
  traefik_letsencrypt:
    driver: local
    name: traefik_letsencrypt

networks:
  virtual-assistant-network:
    external: true
    name: virtual-assistant-network


