# TASK-EML-010: Security and Privacy Review for Gmail Integration

**Section**: 7.6 (Security & privacy review)  
**Subsection**: 7.6  
**Task ID**: TASK-EML-010

## Description

This task involves performing and documenting a comprehensive security and privacy review of the Gmail integration, covering OAuth scopes, logging practices, data retention policies, and credential revocation procedures. The review will identify any security or privacy concerns and document remediation steps.

This ensures the Gmail integration follows security best practices and protects user privacy.

**Reference Implementation**: 
- `cursor-runner/src/logger.ts` (for logging patterns)
- `cursor-runner/src/conversation-service.ts` (for data retention patterns)
- TASK-EML-002 output (`config.md`) for OAuth scope documentation
- Security best practices documentation

## Current State

- **Gmail Integration Exists**: Gmail MCP is configured and wired (TASK-EML-004, TASK-EML-005)
- **OAuth Scopes Defined**: TASK-EML-002 documented required scopes
- **Logging Exists**: cursor-runner has logging infrastructure
- **Data Storage**: Conversation history stored in Redis
- **No Security Review**: No documented security/privacy review exists
- **Dependencies**: 
  - TASK-EML-002: OAuth scopes should be documented
  - TASK-EML-005: Env vars should be wired
  - TASK-EML-008: Integration should be working

**Important**: This task should be completed before production deployment to ensure security and privacy concerns are addressed.

## Checklist

### Preparation and Setup

- [ ] Review TASK-EML-002 output (`config.md`) for OAuth scope documentation
- [ ] Review `cursor-runner/src/logger.ts` to understand logging patterns
- [ ] Review `cursor-runner/src/conversation-service.ts` to understand data storage
- [ ] Review Gmail OAuth documentation for scope security implications
- [ ] Review security best practices for OAuth refresh tokens
- [ ] Review data privacy regulations (GDPR, etc.) if applicable
- [ ] Understand what Gmail data is accessed and stored

### Implementation Steps

- [ ] Step 1: Review OAuth scopes
  - [ ] Review scopes documented in TASK-EML-002
  - [ ] Verify scopes are minimal (least privilege)
  - [ ] Check if any scopes can be removed or narrowed
  - [ ] Document scope rationale and security implications
  - [ ] Document any scope limitations or restrictions
- [ ] Step 2: Audit logging practices
  - [ ] Review `cursor-runner/src/logger.ts` and all logging calls
  - [ ] Identify where Gmail data might be logged:
    - [ ] Email bodies in logs
    - [ ] Email addresses in logs
    - [ ] Thread IDs in logs
    - [ ] OAuth tokens in logs (should never happen)
  - [ ] Document logging of Gmail data
  - [ ] Implement or document truncation/redaction if needed:
    - [ ] Truncate email bodies in logs (e.g., first 100 chars only)
    - [ ] Redact sensitive email addresses if needed
    - [ ] Never log OAuth tokens or refresh tokens
  - [ ] Update logging code if changes needed
- [ ] Step 3: Document data retention
  - [ ] Review `cursor-runner/src/conversation-service.ts`
  - [ ] Document what Gmail-derived data is stored:
    - [ ] Conversation history in Redis (may include email summaries)
    - [ ] Any persisted summaries or extracted data
    - [ ] Any cached Gmail data
  - [ ] Document retention policies:
    - [ ] How long conversation history is kept
    - [ ] How long extracted data is kept
    - [ ] How to purge Gmail-derived data
  - [ ] Document data deletion procedures
- [ ] Step 4: Document credential revocation
  - [ ] Document how to revoke Gmail access:
    - [ ] Revoke OAuth tokens (Google OAuth console)
    - [ ] Disable `GMAIL_*` env vars
    - [ ] Remove Gmail MCP entry from `mcp.json`
    - [ ] Clear any cached Gmail data
  - [ ] Document emergency revocation procedure
  - [ ] Document how to verify revocation
- [ ] Step 5: Create security/privacy document
  - [ ] Create `assistant-integrations/cursor-runner/plan/email/security-privacy-gmail.md`
  - [ ] Document:
    - [ ] OAuth scope review and rationale
    - [ ] Logging practices and data redaction
    - [ ] Data retention policies
    - [ ] Credential revocation procedures
    - [ ] Security best practices
    - [ ] Privacy considerations
  - [ ] Include any code changes needed (logging truncation, etc.)
- [ ] Step 6: Implement code changes (if needed)
  - [ ] If logging needs truncation/redaction:
    - [ ] Update `cursor-runner/src/logger.ts` or relevant logging code
    - [ ] Add helper functions to truncate email bodies
    - [ ] Add helper functions to redact sensitive data
    - [ ] Update all Gmail-related logging to use truncation
  - [ ] Add tests for logging truncation (if implemented)

### Specific Requirements

- [ ] Requirement 1: OAuth Scope Review
  - [ ] **Acceptance Criteria**: All OAuth scopes are reviewed and documented
  - [ ] **Acceptance Criteria**: Scopes follow least-privilege principle
  - [ ] **Acceptance Criteria**: Scope rationale is documented
  - [ ] **Acceptance Criteria**: Any unnecessary scopes are removed
- [ ] Requirement 2: Logging Security
  - [ ] **Acceptance Criteria**: Email bodies are truncated or redacted in logs
  - [ ] **Acceptance Criteria**: OAuth tokens are never logged
  - [ ] **Acceptance Criteria**: Sensitive email addresses are handled appropriately
  - [ ] **Acceptance Criteria**: Logging practices are documented
- [ ] Requirement 3: Data Retention
  - [ ] **Acceptance Criteria**: Data retention policies are documented
  - [ ] **Acceptance Criteria**: Procedures for purging Gmail data are documented
  - [ ] **Acceptance Criteria**: Retention periods are defined
- [ ] Requirement 4: Credential Revocation
  - [ ] **Acceptance Criteria**: Revocation procedures are documented
  - [ ] **Acceptance Criteria**: Emergency revocation is documented
  - [ ] **Acceptance Criteria**: Verification steps are included

### Error Handling and Edge Cases

- [ ] Handle logging of large email bodies: Truncate to prevent log bloat
- [ ] Handle logging of sensitive data: Redact or exclude
- [ ] Handle credential leaks: Document incident response
- [ ] Handle data breach scenarios: Document response procedures

### Testing

- [ ] If logging truncation is implemented:
  - [ ] Write unit tests for truncation functions:
    - [ ] Test truncation of email bodies
    - [ ] Test redaction of sensitive data
    - [ ] Test edge cases (empty strings, very long strings)
  - [ ] Write integration test to verify logs don't contain full email bodies
- [ ] Run full test suite: `npm test` in `cursor-runner`
- [ ] Run type checking: `npm run type-check` (if applicable)
- [ ] Run linting: `npm run lint`
- [ ] **DO NOT manually test by running the server** - use automated tests instead

### Documentation

- [ ] Create `assistant-integrations/cursor-runner/plan/email/security-privacy-gmail.md` with:
  - [ ] OAuth scope review and rationale
  - [ ] Logging practices and data handling
  - [ ] Data retention policies
  - [ ] Credential revocation procedures
  - [ ] Security best practices
  - [ ] Privacy considerations
- [ ] Document any code changes made (logging truncation, etc.)
- [ ] Document follow-up tasks if security improvements are needed

### Verification

- [ ] Verify OAuth scopes are minimal and documented
- [ ] Verify logging doesn't expose sensitive Gmail data
- [ ] Verify data retention policies are defined
- [ ] Verify revocation procedures are documented
- [ ] Verify any code changes are tested
- [ ] Verify documentation is complete

## Notes

- This task is part of the **Email Integration Master Plan - Phase 3: Security and Rollout**
- **Execution Timing**: Should be completed before production deployment, after core implementation
- **Dependencies**: 
  - TASK-EML-002: OAuth scopes should be documented
  - TASK-EML-005: Env vars should be wired
  - TASK-EML-008: Integration should be working
- **Important Considerations**: 
  - Security is critical - never log OAuth tokens or full email bodies
  - Privacy is important - document data retention and deletion
  - Least privilege for OAuth scopes
  - Clear revocation procedures are essential
  - Consider GDPR and other privacy regulations
  - Any security issues found should be tracked as follow-up tasks
- **Task Independence**: Can be completed independently, but benefits from completed implementation
- **Current State**: No security/privacy review exists; this task creates it

## Related Tasks

- Previous: TASK-EML-008 (Integration Tests), TASK-EML-009 (Smoke Test)
- Next: TASK-EML-011 (Rollout Planning)
- Dependencies:
  - TASK-EML-002: Provides OAuth scope documentation
  - TASK-EML-005: Provides env var wiring
  - TASK-EML-008: Provides working integration to review
- Related:
  - TASK-EML-002: Security review validates the configuration contract
  - TASK-EML-011: Rollout plan should incorporate security findings

## Definition of Done

This is a **DOCUMENTATION TASK** (Type 3) with potential **CODE/FILE WRITING TASK** (Type 1) components if code changes are needed.

### User Stories Validation

- [ ] **As a security engineer**: A documented review exists covering how Gmail data is accessed, stored, and logged, enabling security compliance and risk assessment
- [ ] **As a customer**: Assurance exists that email contents are handled responsibly, with clear data retention and revocation procedures

### Documentation Requirements

- [ ] `assistant-integrations/cursor-runner/plan/email/security-privacy-gmail.md` exists and contains:
  - [ ] OAuth scope review:
    - [ ] All scopes listed with rationale
    - [ ] Least-privilege approach documented
    - [ ] Any scope limitations noted
  - [ ] Logging practices:
    - [ ] What Gmail data is logged (if any)
    - [ ] Truncation/redaction procedures
    - [ ] What is never logged (OAuth tokens, full email bodies)
  - [ ] Data retention:
    - [ ] What Gmail-derived data is stored
    - [ ] Retention periods
    - [ ] Deletion procedures
  - [ ] Credential revocation:
    - [ ] How to revoke OAuth tokens
    - [ ] How to disable Gmail integration
    - [ ] How to clear cached data
    - [ ] Emergency revocation procedures
  - [ ] Security best practices
  - [ ] Privacy considerations
- [ ] Any follow-up tasks for security improvements are documented

### Code Changes (if needed)

- [ ] If logging truncation is needed:
  - [ ] `cursor-runner/src/logger.ts` or relevant files include truncation functions
  - [ ] All Gmail-related logging uses truncation
  - [ ] Tests exist for truncation functions
- [ ] Code changes follow existing patterns
- [ ] Code changes are tested

### Automated Tests (if code changes made)

- [ ] If logging truncation is implemented:
  - [ ] Unit tests for truncation functions:
    - [ ] Test truncation of email bodies
    - [ ] Test redaction of sensitive data
    - [ ] Test edge cases
  - [ ] Integration test to verify logs don't contain full email bodies
- [ ] All existing tests still pass: `npm test`
- [ ] Type checking passes: `npm run type-check` (if applicable)
- [ ] Linting passes: `npm run lint`

### Git Commit and Push

- [ ] Planning doc committed to `assistant-integrations/cursor-runner` repository:
  - [ ] Commit message: `docs(email): add security and privacy review for gmail integration`
  - [ ] File: `assistant-integrations/cursor-runner/plan/email/security-privacy-gmail.md` (new file)
  - [ ] Push to origin: `git push origin <branch-name>`
- [ ] Code changes (if any) committed to `cursor-runner` repository:
  - [ ] Commit message: `feat(email): implement logging truncation for gmail data` (or similar)
  - [ ] Files modified: logging-related files, tests
  - [ ] Push to origin: `git push origin <branch-name>`
- [ ] Both commits are verified in remote repositories

### Final Verification

- [ ] Security/privacy document exists and is complete
- [ ] OAuth scopes are reviewed and minimal
- [ ] Logging practices protect sensitive data
- [ ] Data retention policies are defined
- [ ] Revocation procedures are documented
- [ ] Any code changes are implemented and tested
- [ ] Follow-up tasks are tracked (if security improvements needed)
- [ ] Task is ready for TASK-EML-011 (rollout planning) to proceed
