# TASK-EML-005: Wire Gmail Env Vars into cursor-runner and Docker Runtime

**Section**: 3, 7.3 (Wire Gmail env vars)  
**Subsection**: 3.3, 7.3  
**Task ID**: TASK-EML-005

## Description

This task involves propagating `GMAIL_*` environment variables into all environments where the Gmail MCP server runs (local development, Docker containers), and adding validation/logging in cursor-runner startup to detect missing Gmail configuration early. This ensures Gmail credentials are available to the Gmail MCP server whenever cursor CLI runs.

This completes the configuration wiring started in TASK-EML-002 and TASK-EML-004, making Gmail MCP fully functional.

**Reference Implementation**: 
- `cursor-runner/.env.example` (for env var patterns)
- `cursor-runner/src/system-settings.ts` (for settings loading/validation)
- `cursor-runner/src/cursor-cli.ts` (to verify env passing)
- `cursor-runner/src/server.ts` or `cursor-runner/src/index.ts` (for startup validation)
- `cursor-runner/docker-compose.yml` (for Docker env wiring)

## Current State

- **Env Vars Defined**: TASK-EML-002 defined `GMAIL_*` env vars in design doc and `.env.example`
- **MCP Config Ready**: TASK-EML-004 registered Gmail MCP in `mcp.json` with env var references
- **No Env Wiring**: `GMAIL_*` env vars are not yet wired through Docker or validated at startup
- **No Validation**: No startup checks exist to detect missing Gmail config
- **Env Passing**: `CursorCLI` should already pass `process.env` to spawned processes (needs verification)
- **Dependencies**: 
  - TASK-EML-002: Provides env var definitions
  - TASK-EML-004: Provides MCP config that references these vars

**Important**: This task must be completed after TASK-EML-002 and TASK-EML-004, as it wires the env vars that those tasks defined and referenced.

## Checklist

### Preparation and Setup

- [ ] Review TASK-EML-002 output (`config.md`) to know all `GMAIL_*` env vars
- [ ] Review `cursor-runner/.env.example` to see current Gmail vars (from TASK-EML-002)
- [ ] Review `cursor-runner/src/system-settings.ts` to understand settings patterns
- [ ] Review `cursor-runner/src/cursor-cli.ts` to verify `process.env` passing
- [ ] Review `cursor-runner/src/server.ts` or `index.ts` for startup hook location
- [ ] Review `cursor-runner/docker-compose.yml` (if exists) for env var patterns
- [ ] Understand when Gmail MCP should be enabled (feature flag from TASK-EML-011, if implemented)

### Implementation Steps

- [ ] Step 1: Verify env var passing
  - [ ] Read `cursor-runner/src/cursor-cli.ts`
  - [ ] Verify `CursorCLI.executeCommand` passes `process.env` to spawned cursor process
  - [ ] Document findings (should already be working, but verify)
  - [ ] Note any env var filtering that might affect Gmail vars
- [ ] Step 2: Update system-settings.ts (if validation needed)
  - [ ] Review `cursor-runner/src/system-settings.ts`
  - [ ] Add getter methods for Gmail env vars (if needed for validation):
    - [ ] `getGmailClientId(): string | undefined`
    - [ ] `getGmailClientSecret(): string | undefined`
    - [ ] `getGmailRefreshToken(): string | undefined`
  - [ ] Add validation method (if needed):
    - [ ] `validateGmailConfig(): { valid: boolean; missing: string[] }`
  - [ ] Follow existing patterns for other API keys
- [ ] Step 3: Add startup validation
  - [ ] Locate startup code in `cursor-runner/src/server.ts` or `index.ts`
  - [ ] Add startup check that:
    - [ ] Checks if Gmail MCP is enabled (via `ENABLE_GMAIL_MCP` flag, if TASK-EML-011 is done)
    - [ ] If enabled, validates required `GMAIL_*` env vars are present
    - [ ] Logs a warning if critical vars are missing
    - [ ] Logs success message if config is complete
  - [ ] Use structured logging (follow existing logger patterns)
  - [ ] Don't fail startup - just warn (Gmail MCP may be optional)
- [ ] Step 4: Update docker-compose.yml (if exists)
  - [ ] Review `cursor-runner/docker-compose.yml`
  - [ ] Add `GMAIL_*` env vars to service definition:
    ```yaml
    environment:
      - GMAIL_CLIENT_ID=${GMAIL_CLIENT_ID}
      - GMAIL_CLIENT_SECRET=${GMAIL_CLIENT_SECRET}
      - GMAIL_REFRESH_TOKEN=${GMAIL_REFRESH_TOKEN}
    ```
  - [ ] Or use `env_file` if preferred pattern
  - [ ] Follow existing env var patterns in compose file
- [ ] Step 5: Document env var flow
  - [ ] Update documentation to explain:
    - [ ] How env vars flow from `.env` → system-settings → cursor process
    - [ ] How Docker compose passes env vars to container
    - [ ] How to set env vars in different environments
  - [ ] Add troubleshooting section for missing env vars

### Specific Requirements

- [ ] Requirement 1: Environment Variable Availability
  - [ ] **Acceptance Criteria**: `GMAIL_*` env vars are available to Gmail MCP server process
  - [ ] **Acceptance Criteria**: `CursorCLI` passes `process.env` (including Gmail vars) to cursor process
  - [ ] **Acceptance Criteria**: Docker container receives `GMAIL_*` env vars from compose file
- [ ] Requirement 2: Startup Validation
  - [ ] **Acceptance Criteria**: Startup check validates Gmail config when Gmail MCP is enabled
  - [ ] **Acceptance Criteria**: Warning is logged if required vars are missing
  - [ ] **Acceptance Criteria**: Success message is logged if config is complete
  - [ ] **Acceptance Criteria**: Startup doesn't fail if Gmail vars are missing (Gmail may be optional)
- [ ] Requirement 3: Docker Integration
  - [ ] **Acceptance Criteria**: `docker-compose.yml` (if exists) passes `GMAIL_*` vars to container
  - [ ] **Acceptance Criteria**: Container can access Gmail env vars at runtime
  - [ ] **Acceptance Criteria**: Env vars are not hard-coded in compose file

### Error Handling and Edge Cases

- [ ] Handle missing env vars: Log warning, don't fail startup
- [ ] Handle partial env vars: Validate which vars are missing and log clearly
- [ ] Handle Gmail MCP disabled: Skip validation if `ENABLE_GMAIL_MCP=false`
- [ ] Handle Docker env var not set: Container should still start (Gmail optional)
- [ ] Handle env var filtering: Ensure Gmail vars aren't filtered out by CursorCLI

### Testing

- [ ] Write unit test for startup validation:
  - [ ] Test with all required Gmail env vars present → should log success
  - [ ] Test with missing required Gmail env vars → should log warning
  - [ ] Test with Gmail MCP disabled → should skip validation
  - [ ] Test validation doesn't throw errors
- [ ] Write unit test for system-settings Gmail methods (if added):
  - [ ] Test getter methods return correct values
  - [ ] Test validation method detects missing vars
- [ ] Write integration test for Docker env vars (or manual verification):
  - [ ] Start container with Gmail env vars set
  - [ ] Verify container can access env vars
  - [ ] Verify Gmail MCP server process sees env vars
- [ ] Run full test suite: `npm test` in `cursor-runner`
- [ ] Run type checking: `npm run type-check` (if applicable)
- [ ] Run linting: `npm run lint`
- [ ] Verify test coverage: `npm run test:coverage` (if applicable)
- [ ] **DO NOT manually test by running the server** - use automated tests instead

### Documentation

- [ ] Update `cursor-runner/src/system-settings.ts` with Gmail config (if validation added)
- [ ] Update `cursor-runner/src/server.ts` or `index.ts` with startup validation
- [ ] Update `cursor-runner/docker-compose.yml` with Gmail env vars (if exists)
- [ ] Update documentation explaining env var flow
- [ ] Add code comments explaining validation logic
- [ ] Document troubleshooting steps for missing env vars

### Verification

- [ ] Verify env vars are passed to cursor process
- [ ] Verify startup validation works correctly
- [ ] Verify Docker env vars are wired (if compose file exists)
- [ ] Verify all tests pass
- [ ] Verify no regressions
- [ ] Verify documentation is complete

## Notes

- This task is part of the **Email Integration Master Plan - Phase 2: Implementation**
- **Execution Timing**: Must be completed after TASK-EML-002 and TASK-EML-004
- **Dependencies**: 
  - TASK-EML-002: Provides env var definitions
  - TASK-EML-004: Provides MCP config that references these vars
- **Important Considerations**: 
  - Don't fail startup if Gmail vars are missing (Gmail may be optional feature)
  - Log warnings clearly so operators can diagnose issues
  - Follow existing patterns for env var handling
  - Consider feature flag from TASK-EML-011 when validating
  - Never log actual secret values - only log that vars are present/missing
- **Task Independence**: Can be completed independently after dependencies are met
- **Current State**: Gmail env vars are defined but not wired; this task wires them

## Related Tasks

- Previous: TASK-EML-002 (Define Gmail Secrets), TASK-EML-004 (MCP Config)
- Next: TASK-EML-006 (Prompt Templates), TASK-EML-008 (Integration Tests)
- Dependencies:
  - TASK-EML-002: Provides env var definitions
  - TASK-EML-004: Provides MCP config
- Related:
  - TASK-EML-011: Feature flag may affect when validation runs
  - TASK-EML-008: Integration tests will verify env vars reach Gmail MCP

## Definition of Done

This is a **CODE/FILE WRITING TASK** (Type 1) with **CONFIGURATION TASK** (Type 5) components.

### User Stories Validation

- [ ] **As an operator**: Gmail credentials are configured once and automatically available to Gmail MCP server whenever cursor runs, without manual intervention
- [ ] **As a developer**: Missing Gmail config is detected early with clear log messages, enabling quick diagnosis of configuration issues

### Code Implementation Requirements

- [ ] `cursor-runner/src/system-settings.ts` includes Gmail config methods (if validation needed):
  - [ ] Getter methods for Gmail env vars
  - [ ] Validation method that checks for required vars
- [ ] `cursor-runner/src/server.ts` or `index.ts` includes startup validation:
  - [ ] Checks Gmail MCP enabled status (if feature flag exists)
  - [ ] Validates required Gmail env vars when enabled
  - [ ] Logs warning if vars are missing
  - [ ] Logs success if config is complete
- [ ] `cursor-runner/docker-compose.yml` (if exists) includes Gmail env vars:
  - [ ] All required `GMAIL_*` vars are passed to container
  - [ ] Uses env var references, not hard-coded values
- [ ] `CursorCLI` (`cursor-runner/src/cursor-cli.ts`) passes `process.env` to spawned processes (verified, not modified)

### Automated Tests

- [ ] Unit test for startup validation:
  - [ ] Test with all Gmail vars present → logs success
  - [ ] Test with missing Gmail vars → logs warning
  - [ ] Test with Gmail MCP disabled → skips validation
  - [ ] Test doesn't throw errors or fail startup
- [ ] Unit test for system-settings Gmail methods (if added):
  - [ ] Test getter methods return correct values
  - [ ] Test validation detects missing vars
- [ ] Integration test for Docker env vars (or manual verification):
  - [ ] Container receives Gmail env vars
  - [ ] Gmail MCP server process can access env vars
- [ ] All existing tests in `cursor-runner` still pass: `npm test`
- [ ] Type checking passes: `npm run type-check` (if applicable)
- [ ] Linting passes: `npm run lint`
- [ ] Test coverage meets project requirements (if applicable)

### Documentation Requirements

- [ ] Documentation explains:
  - [ ] How env vars flow from `.env` → system-settings → cursor process
  - [ ] How Docker compose passes env vars
  - [ ] How to set env vars in different environments
  - [ ] Troubleshooting steps for missing env vars
- [ ] Code comments explain validation logic
- [ ] Startup logs are clear and actionable

### Git Commit and Push

- [ ] All changes are committed to `cursor-runner` repository:
  - [ ] Commit message: `feat(email): wire gmail env vars into cursor-runner runtime`
  - [ ] Files modified:
    - [ ] `cursor-runner/src/system-settings.ts` (if Gmail config added)
    - [ ] `cursor-runner/src/server.ts` or `index.ts` (startup validation)
    - [ ] `cursor-runner/docker-compose.yml` (if env vars added)
    - [ ] `cursor-runner/tests/test_system_settings.test.ts` (if tests added)
    - [ ] `cursor-runner/tests/test_server.test.ts` (if startup tests added)
    - [ ] Documentation files (if updated)
- [ ] Changes are pushed to origin: `git push origin <branch-name>`
- [ ] Push is verified (check remote repository to confirm)

### Final Verification

- [ ] Gmail env vars are available to cursor process
- [ ] Startup validation works correctly
- [ ] Docker env vars are wired (if compose file exists)
- [ ] All tests pass
- [ ] No regressions introduced
- [ ] Documentation is complete
- [ ] Task is ready for TASK-EML-006 and TASK-EML-008 to proceed
