# TASK-EML-007: Design End-to-End Gmail Flow Scenarios

**Section**: 6 (End-to-End Flow Design)  
**Subsection**: 6.1, 6.2, 6.3  
**Task ID**: TASK-EML-007

## Description

This task involves creating detailed documentation of end-to-end Gmail flow scenarios that will be used to drive integration tests, acceptance criteria, and user acceptance testing. Each flow describes the complete path from trigger (jarek-va task, scheduled agent, manual) through cursor-runner execution to result handling.

These flows will be used by TASK-EML-008 to implement integration tests and by operators to understand expected behavior.

**Reference Implementation**: 
- `cursor-runner/src/server.ts` (for HTTP endpoint definitions)
- `cursor-runner/src/cursor-execution-service.ts` (for execution flow)
- TASK-EML-006 output (`prompts-gmail.md`) for prompt templates
- jarek-va integration patterns (if documented)

## Current State

- **No Gmail Flows**: No end-to-end Gmail flow scenarios are documented
- **Prompt Templates Exist**: TASK-EML-006 provides Gmail prompt templates
- **API Endpoints Exist**: `cursor-runner` has `/cursor/iterate` and related endpoints
- **No Test Scenarios**: Integration tests (TASK-EML-008) need these flows to test against
- **Dependencies**: 
  - TASK-EML-006: Prompt templates should be available
  - TASK-EML-001: Need to understand API endpoints

**Important**: This task can be completed in parallel with implementation, but should reference actual API endpoints and prompt templates.

## Checklist

### Preparation and Setup

- [ ] Review `cursor-runner/src/server.ts` to understand HTTP endpoints:
  - [ ] `POST /cursor/iterate` - iterative execution
  - [ ] `POST /cursor/iterate/async` - async iterative execution
  - [ ] Request/response shapes
- [ ] Review `cursor-runner/src/cursor-execution-service.ts` to understand execution flow
- [ ] Review TASK-EML-006 output (`prompts-gmail.md`) for prompt templates
- [ ] Review jarek-va integration patterns (if documented)
- [ ] Understand conversation context and how it's built
- [ ] Understand callback/webhook mechanisms

### Implementation Steps

- [ ] Step 1: Define primary Gmail flows
  - [ ] Flow 1: Summarize unread inbox messages
    - [ ] Trigger: jarek-va task or scheduled agent
    - [ ] HTTP call: `POST /cursor/iterate/async` with Gmail prompt
    - [ ] Prompt: Use template from TASK-EML-006
    - [ ] Execution: cursor CLI invokes Gmail MCP tools
    - [ ] Result: Summary returned to jarek-va
  - [ ] Flow 2: Draft and send reply for thread
    - [ ] Trigger: jarek-va task with thread ID
    - [ ] HTTP call: `POST /cursor/iterate` with reply prompt
    - [ ] Prompt: Use template from TASK-EML-006
    - [ ] Execution: cursor CLI reads thread, drafts reply
    - [ ] Result: Drafted reply returned (or sent if prompt includes send)
  - [ ] Flow 3: Extract receipts and store
    - [ ] Trigger: Scheduled agent (daily/hourly)
    - [ ] HTTP call: `POST /cursor/iterate/async` with extraction prompt
    - [ ] Prompt: Use template from TASK-EML-006
    - [ ] Execution: cursor CLI extracts structured data
    - [ ] Result: JSON data returned to jarek-va for storage
- [ ] Step 2: Document each flow in detail
  - [ ] For each flow, document:
    - [ ] **Trigger Source**: 
      - [ ] jarek-va task (HTTP call details)
      - [ ] Scheduled agent (cron pattern, agent config)
      - [ ] Manual trigger (how to invoke)
    - [ ] **HTTP Request**:
      - [ ] Endpoint: `/cursor/iterate` or `/cursor/iterate/async`
      - [ ] Method: POST
      - [ ] Headers: Content-Type, Authorization (if needed)
      - [ ] Request body: `{ prompt, repository?, branchName?, callbackUrl?, conversationId?, maxIterations? }`
      - [ ] Example request body with actual values
    - [ ] **Prompt Construction**:
      - [ ] Base prompt from TASK-EML-006 template
      - [ ] How conversation context is prepended
      - [ ] How system instructions are appended
      - [ ] Full prompt example
    - [ ] **Gmail MCP Tool Calls**:
      - [ ] Expected tools: listMessages, getMessage, sendReply, etc.
      - [ ] Tool parameters
      - [ ] Expected tool outputs
    - [ ] **Execution Path**:
      - [ ] cursor-runner receives request
      - [ ] CursorExecutionService.iterate is called
      - [ ] Prompt is built with context
      - [ ] CursorCLI.executeCommand runs cursor CLI
      - [ ] cursor CLI discovers Gmail MCP tools
      - [ ] cursor CLI calls Gmail MCP tools
      - [ ] Results are captured
    - [ ] **Result Handling**:
      - [ ] Response body shape: `{ success, requestId, output, error?, iterations, ... }`
      - [ ] How results are returned to jarek-va
      - [ ] How results are stored (conversation history, callback webhook)
      - [ ] Expected output format
- [ ] Step 3: Create flows document
  - [ ] Create `assistant-integrations/cursor-runner/plan/email/flows-gmail.md`
  - [ ] Document all 3+ primary flows
  - [ ] Include diagrams if helpful (sequence diagrams, flow charts)
  - [ ] Reference actual endpoints and payload shapes
  - [ ] Include example requests and responses
- [ ] Step 4: Document error scenarios
  - [ ] For each flow, document:
    - [ ] What happens if Gmail MCP is unavailable
    - [ ] What happens if auth fails
    - [ ] What happens if no messages found
    - [ ] What happens if rate limit hit
    - [ ] Error response shapes

### Specific Requirements

- [ ] Requirement 1: Flow Documentation
  - [ ] **Acceptance Criteria**: At least 3 primary Gmail flows are documented
  - [ ] **Acceptance Criteria**: Each flow includes trigger, HTTP request, prompt construction, tool calls, execution path, and result handling
  - [ ] **Acceptance Criteria**: Flows reference real endpoints and payload shapes from cursor-runner
- [ ] Requirement 2: Detail Level
  - [ ] **Acceptance Criteria**: Flows are detailed enough to implement integration tests
  - [ ] **Acceptance Criteria**: Example requests and responses are included
  - [ ] **Acceptance Criteria**: Expected Gmail MCP tool calls are documented
- [ ] Requirement 3: Error Scenarios
  - [ ] **Acceptance Criteria**: Error scenarios are documented for each flow
  - [ ] **Acceptance Criteria**: Error response shapes are included

### Error Handling and Edge Cases

- [ ] Document error scenarios for each flow:
  - [ ] Gmail MCP unavailable
  - [ ] Authentication failures
  - [ ] No messages found
  - [ ] Rate limits
  - [ ] Invalid thread IDs
  - [ ] Network errors
- [ ] Document how errors are surfaced to jarek-va
- [ ] Document retry behavior (if any)

### Testing

- [ ] No code tests yet; these flows will be used as the basis for TASK-EML-008 integration tests
- [ ] Manual review: Flows should be reviewed for:
  - [ ] Completeness (all steps documented)
  - [ ] Accuracy (endpoints and payloads are correct)
  - [ ] Actionability (can tests be written from these?)
- [ ] Peer review: Have another developer review flows

### Documentation

- [ ] Create `assistant-integrations/cursor-runner/plan/email/flows-gmail.md` with:
  - [ ] Overview of Gmail flows
  - [ ] Detailed documentation of each primary flow
  - [ ] Example requests and responses
  - [ ] Error scenarios
  - [ ] Diagrams (if helpful)
- [ ] Reference prompt templates from TASK-EML-006
- [ ] Reference actual API endpoints from cursor-runner
- [ ] Include code examples and payload samples

### Verification

- [ ] Verify all flows are documented in detail
- [ ] Verify flows reference real endpoints
- [ ] Verify flows are actionable for test implementation
- [ ] Verify documentation is complete

## Notes

- This task is part of the **Email Integration Master Plan - Phase 2: Implementation**
- **Execution Timing**: Can be completed in parallel with implementation, but should reference actual endpoints
- **Dependencies**: 
  - TASK-EML-006: Prompt templates should be available
  - TASK-EML-001: Need to understand API endpoints
- **Important Considerations**: 
  - Flows must reference real endpoints and payload shapes
  - Flows should be detailed enough to write tests from
  - Include both happy path and error scenarios
  - Consider async vs sync execution patterns
  - Document callback/webhook mechanisms
- **Task Independence**: Can be completed independently, but benefits from prompt templates
- **Current State**: No Gmail flow scenarios exist; this task creates them

## Related Tasks

- Previous: TASK-EML-006 (Prompt Templates)
- Next: TASK-EML-008 (Integration Tests - will use these flows)
- Dependencies:
  - TASK-EML-006: Provides prompt templates
  - TASK-EML-001: Provides API endpoint understanding
- Related:
  - TASK-EML-008: Will implement tests based on these flows
  - TASK-EML-009: Smoke test may use these flows

## Definition of Done

This is a **DOCUMENTATION TASK** (Type 3).

### User Stories Validation

- [ ] **As a product owner**: Clear end-to-end Gmail scenarios (e.g., "summarize my inbox") are spelled out with enough detail to test what matters
- [ ] **As a QA engineer**: Concrete flows exist that can drive integration and acceptance tests, enabling comprehensive test coverage

### Documentation Requirements

- [ ] `assistant-integrations/cursor-runner/plan/email/flows-gmail.md` exists and contains:
  - [ ] At least 3 primary Gmail flows:
    - [ ] Summarize unread inbox messages flow
    - [ ] Draft and send reply for thread flow
    - [ ] Extract receipts and store flow
  - [ ] For each flow, complete documentation of:
    - [ ] Trigger source (jarek-va task, scheduled agent, manual)
    - [ ] Exact HTTP calls (endpoint, method, headers, request body with examples)
    - [ ] Prompt construction (base template, context prepending, system instructions)
    - [ ] Expected Gmail MCP tool calls (tools, parameters, outputs)
    - [ ] Execution path (step-by-step through cursor-runner)
    - [ ] Result handling (response shape, storage, callback/webhook)
  - [ ] Error scenarios for each flow
  - [ ] Example requests and responses
  - [ ] Diagrams if helpful
- [ ] Flows reference real endpoints and payload shapes from `cursor-runner`
- [ ] Flows are detailed enough to implement integration tests
- [ ] Documentation is complete and actionable

### Review and Validation

- [ ] Flows are reviewed for completeness and accuracy
- [ ] Flows are verified to reference correct endpoints
- [ ] Flows are verified to be actionable for test implementation
- [ ] Peer review completed (another developer reviewed flows)

### Git Commit and Push

- [ ] All changes are committed to `assistant-integrations/cursor-runner` repository:
  - [ ] Commit message: `docs(email): define end-to-end gmail flow scenarios`
  - [ ] File: `assistant-integrations/cursor-runner/plan/email/flows-gmail.md` (new file)
- [ ] Changes are pushed to origin: `git push origin <branch-name>`
- [ ] Push is verified (check remote repository to confirm)

### Final Verification

- [ ] Flows document exists with all primary scenarios
- [ ] Flows reference real endpoints and payloads
- [ ] Flows are detailed enough for test implementation
- [ ] Documentation is complete
- [ ] Task is ready for TASK-EML-008 to use these flows for integration tests
