# TASK-EML-008: Implement Integration Tests for Gmail Flows (Mocked MCP)

**Section**: 7.5 (Integration tests)  
**Subsection**: 7.5  
**Task ID**: TASK-EML-008

## Description

This task involves creating comprehensive integration tests for Gmail flows that mock the Gmail MCP server and verify that cursor-runner correctly invokes Gmail MCP tools when processing Gmail-related prompts. The tests will validate the contract between cursor-runner and Gmail MCP without requiring real Gmail accounts.

These tests will use the flows defined in TASK-EML-007 and ensure that the integration works correctly at the protocol/contract level.

**Reference Implementation**: 
- `cursor-runner/tests/server.test.ts` (for HTTP endpoint testing patterns)
- `cursor-runner/tests/cursor-cli.test.ts` (for cursor CLI mocking patterns)
- TASK-EML-007 output (`flows-gmail.md`) for test scenarios
- MCP protocol documentation (for mocking MCP server)

## Current State

- **No Gmail Tests**: No integration tests exist for Gmail MCP flows
- **Test Infrastructure**: `cursor-runner` has Jest test setup and patterns
- **MCP Mocking**: Need to create mocked Gmail MCP server
- **Flows Defined**: TASK-EML-007 provides detailed flow scenarios to test
- **Dependencies**: 
  - TASK-EML-004: Gmail MCP should be configured
  - TASK-EML-005: Env vars should be wired
  - TASK-EML-007: Flows should be documented

**Important**: This task must be completed after TASK-EML-004, TASK-EML-005, and TASK-EML-007, as it tests the complete integration.

## Checklist

### Preparation and Setup

- [ ] Review `cursor-runner/tests/` to understand test patterns
- [ ] Review `cursor-runner/tests/server.test.ts` for HTTP endpoint testing
- [ ] Review `cursor-runner/tests/cursor-cli.test.ts` for cursor CLI mocking
- [ ] Review TASK-EML-007 output (`flows-gmail.md`) for test scenarios
- [ ] Research MCP protocol for mocking MCP server
- [ ] Understand how to mock subprocess/child process for MCP server
- [ ] Review Jest mocking patterns for async operations

### Implementation Steps

- [ ] Step 1: Create mocked Gmail MCP server
  - [ ] Create `cursor-runner/tests/helpers/mock-gmail-mcp-server.ts` (or similar)
  - [ ] Implement mock that:
    - [ ] Listens on a local port or simulates MCP process
    - [ ] Provides stub tool definitions matching Gmail MCP tools:
      - [ ] `listMessages` - returns mock message list
      - [ ] `getMessage` - returns mock message details
      - [ ] `sendReply` - returns mock send confirmation
    - [ ] Handles MCP protocol messages (initialize, tools/list, tools/call)
    - [ ] Returns predictable responses for testing
  - [ ] Make mock configurable (different responses for different test cases)
- [ ] Step 2: Create integration test file
  - [ ] Create `cursor-runner/tests/test_gmail_integration.test.ts`
  - [ ] Set up test infrastructure:
    - [ ] Mock Gmail MCP server setup/teardown
    - [ ] Test server setup (FastAPI test client or similar)
    - [ ] Environment variable mocking
    - [ ] Cleanup after each test
- [ ] Step 3: Implement happy path tests
  - [ ] Test 1: Summarize unread messages flow
    - [ ] Mock Gmail MCP to return sample messages
    - [ ] Call `POST /cursor/iterate` with summarize prompt
    - [ ] Verify cursor CLI is invoked
    - [ ] Verify Gmail MCP tools are called (listMessages)
    - [ ] Verify response includes summary
  - [ ] Test 2: Draft reply flow
    - [ ] Mock Gmail MCP to return thread messages
    - [ ] Call `POST /cursor/iterate` with draft reply prompt
    - [ ] Verify Gmail MCP tools are called (getMessage, sendReply)
    - [ ] Verify response includes drafted reply
  - [ ] Test 3: Extract receipts flow
    - [ ] Mock Gmail MCP to return receipt emails
    - [ ] Call `POST /cursor/iterate` with extraction prompt
    - [ ] Verify Gmail MCP tools are called (listMessages, getMessage)
    - [ ] Verify response includes structured JSON data
- [ ] Step 4: Implement error path tests
  - [ ] Test: Gmail MCP unavailable
    - [ ] Simulate Gmail MCP server not starting
    - [ ] Call endpoint with Gmail prompt
    - [ ] Verify error is handled gracefully
    - [ ] Verify error message is clear
  - [ ] Test: Authentication failure
    - [ ] Mock Gmail MCP to return auth error
    - [ ] Call endpoint with Gmail prompt
    - [ ] Verify error is surfaced correctly
  - [ ] Test: No messages found
    - [ ] Mock Gmail MCP to return empty results
    - [ ] Call endpoint with Gmail prompt
    - [ ] Verify response handles empty results gracefully
- [ ] Step 5: Ensure test cleanup
  - [ ] All mocked processes are terminated after tests
  - [ ] All listeners are cleaned up
  - [ ] No hanging servers or processes
  - [ ] Follow safe testing practices from Software Developer instructions

### Specific Requirements

- [ ] Requirement 1: Mocked Gmail MCP Server
  - [ ] **Acceptance Criteria**: Mock server implements MCP protocol
  - [ ] **Acceptance Criteria**: Mock provides stub tool definitions matching Gmail MCP
  - [ ] **Acceptance Criteria**: Mock returns configurable responses
  - [ ] **Acceptance Criteria**: Mock can simulate different scenarios (success, errors, empty results)
- [ ] Requirement 2: Integration Tests
  - [ ] **Acceptance Criteria**: Tests cover at least 3 main Gmail flows from TASK-EML-007
  - [ ] **Acceptance Criteria**: Tests verify cursor CLI is invoked with MCP available
  - [ ] **Acceptance Criteria**: Tests verify Gmail MCP tools are called correctly
  - [ ] **Acceptance Criteria**: Tests verify response includes expected Gmail-derived fields
- [ ] Requirement 3: Error Handling Tests
  - [ ] **Acceptance Criteria**: Tests cover failure modes (MCP unavailable, auth errors, empty results)
  - [ ] **Acceptance Criteria**: Tests verify errors surface correctly
  - [ ] **Acceptance Criteria**: Tests verify graceful error handling

### Error Handling and Edge Cases

- [ ] Test Gmail MCP server not starting
- [ ] Test Gmail MCP server crashing mid-execution
- [ ] Test authentication failures from Gmail MCP
- [ ] Test rate limit errors
- [ ] Test network timeouts
- [ ] Test invalid tool parameters
- [ ] Test empty results from Gmail MCP
- [ ] Test malformed responses from Gmail MCP

### Testing

- [ ] Write integration tests in `cursor-runner/tests/test_gmail_integration.test.ts`:
  - [ ] Happy path tests for main flows
  - [ ] Error path tests for failure modes
  - [ ] Edge case tests
- [ ] Ensure all tests follow safe testing practices:
  - [ ] No hanging servers
  - [ ] All processes terminated
  - [ ] All listeners cleaned up
  - [ ] Use Jest's `afterEach`/`afterAll` for cleanup
- [ ] Run full test suite: `npm test` in `cursor-runner`
- [ ] Run tests in isolation: `npm test -- test_gmail_integration.test.ts`
- [ ] Run type checking: `npm run type-check` (if applicable)
- [ ] Run linting: `npm run lint`
- [ ] Verify test coverage: `npm run test:coverage` (if applicable)
- [ ] **DO NOT manually test by running the server** - use automated tests instead

### Documentation

- [ ] Add code comments explaining mock Gmail MCP server
- [ ] Document test scenarios and what they verify
- [ ] Document how to extend tests for new flows
- [ ] Update test README if one exists

### Verification

- [ ] Verify all main flows have tests
- [ ] Verify error scenarios are covered
- [ ] Verify tests pass reliably
- [ ] Verify no hanging processes or listeners
- [ ] Verify test cleanup works correctly
- [ ] Verify no regressions in existing tests

## Notes

- This task is part of the **Email Integration Master Plan - Phase 2: Implementation**
- **Execution Timing**: Must be completed after TASK-EML-004, TASK-EML-005, and TASK-EML-007
- **Dependencies**: 
  - TASK-EML-004: Gmail MCP must be configured
  - TASK-EML-005: Env vars must be wired
  - TASK-EML-007: Flows must be documented
- **Important Considerations**: 
  - Mock Gmail MCP server must implement MCP protocol correctly
  - Tests must not require real Gmail accounts
  - Follow safe testing practices - no hanging servers
  - Ensure all processes and listeners are cleaned up
  - Tests should be fast and reliable
  - Mock should be configurable for different test scenarios
- **Task Independence**: Can be completed independently after dependencies are met
- **Current State**: No Gmail integration tests exist; this task creates them

## Related Tasks

- Previous: TASK-EML-004 (MCP Config), TASK-EML-005 (Env Vars), TASK-EML-007 (Flows)
- Next: TASK-EML-009 (Optional Smoke Test)
- Dependencies:
  - TASK-EML-004: Provides Gmail MCP configuration to test
  - TASK-EML-005: Provides env var wiring to test
  - TASK-EML-007: Provides flow scenarios to test
- Related:
  - TASK-EML-009: Smoke test will complement these integration tests

## Definition of Done

This is a **TESTING TASK** (Type 4) with **CODE/FILE WRITING TASK** (Type 1) components.

### User Stories Validation

- [ ] **As a developer**: Automated tests prove cursor-runner calls Gmail MCP correctly at the protocol/contract level without needing real Gmail, enabling confident development and refactoring
- [ ] **As a QA engineer**: Repeatable tests validate happy paths and error conditions, ensuring reliable Gmail integration behavior

### Code Implementation Requirements

- [ ] `cursor-runner/tests/helpers/mock-gmail-mcp-server.ts` (or similar) exists with:
  - [ ] MCP protocol implementation (initialize, tools/list, tools/call)
  - [ ] Stub Gmail MCP tool definitions (listMessages, getMessage, sendReply)
  - [ ] Configurable responses for different test scenarios
  - [ ] Proper cleanup and teardown
- [ ] `cursor-runner/tests/test_gmail_integration.test.ts` exists with:
  - [ ] Test setup/teardown infrastructure
  - [ ] Happy path tests for main Gmail flows (3+ tests)
  - [ ] Error path tests for failure modes (2+ tests)
  - [ ] Proper cleanup (no hanging processes)

### Automated Tests

- [ ] Integration tests cover:
  - [ ] Summarize unread messages flow (happy path)
  - [ ] Draft reply flow (happy path)
  - [ ] Extract receipts flow (happy path)
  - [ ] Gmail MCP unavailable (error path)
  - [ ] Authentication failure (error path)
  - [ ] Empty results handling (edge case)
- [ ] Tests verify:
  - [ ] Cursor CLI is invoked with MCP available
  - [ ] Gmail MCP tools are called correctly
  - [ ] Response includes expected Gmail-derived fields
  - [ ] Errors are handled gracefully
- [ ] All tests follow safe testing practices:
  - [ ] No hanging servers or processes
  - [ ] All listeners cleaned up
  - [ ] Proper use of Jest cleanup hooks
- [ ] All existing tests in `cursor-runner` still pass: `npm test`
- [ ] New Gmail tests pass: `npm test -- test_gmail_integration.test.ts`
- [ ] Type checking passes: `npm run type-check` (if applicable)
- [ ] Linting passes: `npm run lint`
- [ ] Test coverage meets project requirements (if applicable)

### Documentation Requirements

- [ ] Code comments explain mock Gmail MCP server implementation
- [ ] Test file includes comments explaining test scenarios
- [ ] Documentation explains how to extend tests for new flows

### Git Commit and Push

- [ ] All changes are committed to `cursor-runner` repository:
  - [ ] Commit message: `test(email): add integration tests for gmail mcp flows`
  - [ ] Files created/modified:
    - [ ] `cursor-runner/tests/test_gmail_integration.test.ts` (new file)
    - [ ] `cursor-runner/tests/helpers/mock-gmail-mcp-server.ts` (new file, if created)
    - [ ] Any test helper utilities
- [ ] Changes are pushed to origin: `git push origin <branch-name>`
- [ ] Push is verified (check remote repository to confirm)

### Final Verification

- [ ] Integration tests exist for main Gmail flows
- [ ] Tests pass reliably in CI and local environments
- [ ] No hanging processes or listeners
- [ ] All tests follow safe testing practices
- [ ] Test coverage is adequate
- [ ] No regressions in existing tests
- [ ] Task is ready for TASK-EML-009 (optional smoke test) to proceed
