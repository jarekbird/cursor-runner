# TASK-EML-004: Extend Cursor MCP Configuration with Gmail Server

**Section**: 3â€“4, 7.2 (MCP configuration)  
**Subsection**: 3.2, 4.2, 7.2  
**Task ID**: TASK-EML-004

## Description

This task involves updating the MCP configuration file(s) in `cursor-runner` to register the Gmail MCP server, making Gmail tools available to cursor CLI when it runs. The Gmail server entry must follow the same pattern as existing MCP servers and reference the `GMAIL_*` environment variables defined in TASK-EML-002.

This enables cursor CLI to discover and use Gmail MCP tools when processing prompts that require email functionality.

**Reference Implementation**: 
- `cursor-runner/mcp.json` (existing MCP server entries like `cursor-runner-shared-sqlite`, `cursor-runner-shared-redis`)
- `cursor-runner/src/workspace-trust-service.ts` (to understand `.cursor/cli.json` creation)

## Current State

- **MCP Configuration Exists**: `cursor-runner/mcp.json` (or equivalent) contains MCP server definitions
- **Existing MCP Servers**: Servers like `cursor-runner-shared-sqlite` and `cursor-runner-shared-redis` are configured
- **No Gmail MCP**: Gmail MCP server is not registered in MCP configuration
- **Workspace Trust**: `WorkspaceTrustService` may create `.cursor/cli.json` files - need to ensure no conflicts
- **Dependencies**: 
  - TASK-EML-001: Need to understand MCP config structure
  - TASK-EML-002: Need to know Gmail env var names
  - TASK-EML-003: Gmail MCP server must be installed

**Important**: This task must be completed after TASK-EML-003 (Gmail MCP installed) and before TASK-EML-005 (env vars wired), as configuration needs the server to exist but doesn't need env vars wired yet.

## Checklist

### Preparation and Setup

- [ ] Review TASK-EML-001 output (`current-state.md`) to understand MCP config location and structure
- [ ] Review `cursor-runner/mcp.json` to see existing MCP server entry patterns
- [ ] Review `cursor-runner/src/workspace-trust-service.ts` to understand `.cursor/cli.json` creation
- [ ] Review TASK-EML-002 output (`config.md`) to know Gmail env var names
- [ ] Verify Gmail MCP server is installed (TASK-EML-003 should be complete)
- [ ] Understand MCP config loading mechanism (where/how is `mcp.json` read?)

### Implementation Steps

- [ ] Step 1: Locate and analyze MCP config
  - [ ] Identify authoritative MCP config file (e.g., `cursor-runner/mcp.json`)
  - [ ] Review existing MCP server entries to understand structure:
    - [ ] Command pattern
    - [ ] Args pattern
    - [ ] Env var references
    - [ ] Naming conventions
  - [ ] Document the pattern to follow
- [ ] Step 2: Add Gmail MCP server entry
  - [ ] Add `gmail` entry to `cursor-runner/mcp.json`:
    ```json
    "gmail": {
      "command": "mcp-server-gmail",
      "args": [],
      "env": {
        "GMAIL_CLIENT_ID": "${GMAIL_CLIENT_ID}",
        "GMAIL_CLIENT_SECRET": "${GMAIL_CLIENT_SECRET}",
        "GMAIL_REFRESH_TOKEN": "${GMAIL_REFRESH_TOKEN}"
      }
    }
    ```
  - [ ] Follow exact pattern of existing entries
  - [ ] Reference all required `GMAIL_*` env vars from TASK-EML-002
  - [ ] Do not inline secrets - use env var references only
  - [ ] Add comments if JSON supports them, or document in separate file
- [ ] Step 3: Verify workspace trust compatibility
  - [ ] Review `cursor-runner/src/workspace-trust-service.ts`
  - [ ] Ensure `.cursor/cli.json` creation doesn't conflict with `mcp.json`
  - [ ] Document any interactions or conflicts
  - [ ] Update workspace trust service if needed to avoid conflicts
- [ ] Step 4: Add feature flag support (if TASK-EML-011 is planned)
  - [ ] Consider conditional inclusion based on `ENABLE_GMAIL_MCP` flag
  - [ ] Document how to disable Gmail MCP (remove entry or use feature flag)
  - [ ] Add comments/docs explaining enable/disable mechanism
- [ ] Step 5: Create validation
  - [ ] Create script or test that loads `mcp.json`
  - [ ] Validate JSON structure is valid
  - [ ] Assert `gmail` entry exists
  - [ ] Assert `gmail` entry has required fields (command, env)
  - [ ] Assert env var references are correct

### Specific Requirements

- [ ] Requirement 1: MCP Config Entry
  - [ ] **Acceptance Criteria**: `gmail` entry exists in `cursor-runner/mcp.json`
  - [ ] **Acceptance Criteria**: Entry follows same structure as existing MCP servers
  - [ ] **Acceptance Criteria**: Command points to `mcp-server-gmail` (or chosen binary name)
  - [ ] **Acceptance Criteria**: Env var references match `GMAIL_*` vars from TASK-EML-002
  - [ ] **Acceptance Criteria**: No secrets are inlined in config
- [ ] Requirement 2: Workspace Trust Compatibility
  - [ ] **Acceptance Criteria**: `.cursor/cli.json` creation doesn't conflict with `mcp.json`
  - [ ] **Acceptance Criteria**: Both configs can coexist
  - [ ] **Acceptance Criteria**: Documented if any special handling is needed
- [ ] Requirement 3: Validation
  - [ ] **Acceptance Criteria**: Automated check validates `gmail` entry exists and is well-formed
  - [ ] **Acceptance Criteria**: Validation fails with clear error if entry is missing or malformed
  - [ ] **Acceptance Criteria**: Validation can be run in CI or locally

### Error Handling and Edge Cases

- [ ] Handle missing `mcp.json`: Document that it needs to be created if it doesn't exist
- [ ] Handle invalid JSON: Validation should catch syntax errors
- [ ] Handle missing required fields: Validation should check for command, env
- [ ] Handle workspace trust conflicts: Document resolution if conflicts exist
- [ ] Handle feature flag: Support conditional inclusion if flag is implemented

### Testing

- [ ] Write unit test for MCP config validation:
  - [ ] Test loading `mcp.json` succeeds
  - [ ] Test `gmail` entry exists
  - [ ] Test `gmail` entry has required structure (command, env)
  - [ ] Test env var references are present
  - [ ] Test validation fails if `gmail` entry is missing
  - [ ] Test validation fails if `gmail` entry is malformed
- [ ] Write integration test (optional but recommended):
  - [ ] Start a dummy `mcp-server-gmail` process
  - [ ] Invoke cursor CLI with a minimal command that lists MCP tools
  - [ ] Verify Gmail tools appear in the tool list
  - [ ] Clean up dummy process
- [ ] Run full test suite: `npm test` in `cursor-runner`
- [ ] Run type checking: `npm run type-check` (if applicable)
- [ ] Run linting: `npm run lint`
- [ ] Verify test coverage: `npm run test:coverage` (if applicable)
- [ ] **DO NOT manually test by running the server** - use automated tests instead

### Documentation

- [ ] Update `cursor-runner/mcp.json` with Gmail entry (add comments if possible)
- [ ] Create or update documentation explaining:
  - [ ] How MCP config is loaded
  - [ ] How to add new MCP servers
  - [ ] How to disable Gmail MCP (feature flag or remove entry)
- [ ] Document workspace trust interaction (if any)
- [ ] Add code comments in validation script/test

### Verification

- [ ] Verify `gmail` entry is correctly structured in `mcp.json`
- [ ] Verify validation script/test works
- [ ] Verify workspace trust doesn't conflict
- [ ] Verify JSON is valid and can be loaded
- [ ] Verify no regressions in existing MCP servers
- [ ] Verify documentation is complete

## Notes

- This task is part of the **Email Integration Master Plan - Phase 2: Implementation**
- **Execution Timing**: Must be completed after TASK-EML-003 (Gmail MCP installed) and before TASK-EML-005 (env vars wired)
- **Dependencies**: 
  - TASK-EML-001: Need to understand MCP config structure
  - TASK-EML-002: Need to know Gmail env var names
  - TASK-EML-003: Gmail MCP server must be installed
- **Important Considerations**: 
  - Follow exact pattern of existing MCP server entries
  - Never inline secrets in config - always use env var references
  - Ensure workspace trust service doesn't conflict
  - Consider feature flag for conditional inclusion (TASK-EML-011)
  - MCP config must be valid JSON
- **Task Independence**: Can be completed independently after dependencies are met
- **Current State**: Gmail MCP is not registered; this task adds it to config

## Related Tasks

- Previous: TASK-EML-003 (Add Gmail MCP Dependency)
- Next: TASK-EML-005 (Wire Gmail Env Vars), TASK-EML-011 (Feature Flagging)
- Dependencies:
  - TASK-EML-001: Provides MCP config structure understanding
  - TASK-EML-002: Provides Gmail env var names
  - TASK-EML-003: Provides installed Gmail MCP server
- Related:
  - TASK-EML-005: Will wire the env vars referenced in this config
  - TASK-EML-011: May add feature flag to conditionally include this entry

## Definition of Done

This is a **CONFIGURATION TASK** (Type 5) with **CODE/FILE WRITING TASK** (Type 1) components.

### User Stories Validation

- [ ] **As a cursor user**: Gmail tools appear automatically via MCP when `cursor-runner` invokes cursor, enabling email operations in prompts
- [ ] **As an operator**: Gmail MCP config is isolated and explicit, allowing easy enable/disable per environment

### Configuration Requirements

- [ ] `cursor-runner/mcp.json` includes `gmail` entry with:
  - [ ] `command`: Points to `mcp-server-gmail` (or chosen binary)
  - [ ] `args`: Any required flags (empty array if none)
  - [ ] `env`: References to all required `GMAIL_*` env vars (no inline secrets)
  - [ ] Structure matches existing MCP server entries
- [ ] Workspace trust service (`cursor-runner/src/workspace-trust-service.ts`) doesn't conflict with `mcp.json`
- [ ] Documentation explains how to disable Gmail MCP (feature flag or remove entry)

### Automated Tests

- [ ] Unit test for MCP config validation:
  - [ ] Test loads `mcp.json` successfully
  - [ ] Test asserts `gmail` entry exists
  - [ ] Test asserts `gmail` entry has required structure (command, env)
  - [ ] Test asserts env var references are correct
  - [ ] Test fails if `gmail` entry is missing
  - [ ] Test fails if `gmail` entry is malformed
- [ ] Integration test (optional but recommended):
  - [ ] Test starts dummy Gmail MCP server
  - [ ] Test invokes cursor CLI to list tools
  - [ ] Test verifies Gmail tools appear
  - [ ] Test cleans up dummy server
- [ ] All existing tests in `cursor-runner` still pass: `npm test`
- [ ] Type checking passes: `npm run type-check` (if applicable)
- [ ] Linting passes: `npm run lint`
- [ ] Test coverage meets project requirements (if applicable)

### Documentation Requirements

- [ ] `cursor-runner/mcp.json` includes Gmail entry with comments/docs (if JSON supports it)
- [ ] Documentation explains:
  - [ ] How MCP config is loaded
  - [ ] How to add new MCP servers (following Gmail pattern)
  - [ ] How to disable Gmail MCP
- [ ] Workspace trust interaction is documented (if any)

### Git Commit and Push

- [ ] All changes are committed to `cursor-runner` repository:
  - [ ] Commit message: `feat(email): register gmail mcp server in cursor mcp config`
  - [ ] Files modified:
    - [ ] `cursor-runner/mcp.json` (Gmail entry added)
    - [ ] `cursor-runner/tests/test_mcp_config.test.ts` (or similar - validation test)
    - [ ] Documentation files (if updated)
- [ ] Changes are pushed to origin: `git push origin <branch-name>`
- [ ] Push is verified (check remote repository to confirm)

### Final Verification

- [ ] `gmail` entry exists in `mcp.json` with correct structure
- [ ] Validation test passes
- [ ] All tests pass
- [ ] Workspace trust doesn't conflict
- [ ] JSON is valid
- [ ] No regressions in existing MCP servers
- [ ] Documentation is complete
- [ ] Task is ready for TASK-EML-005 to proceed
