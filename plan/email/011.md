# TASK-EML-011: Rollout Planning and Feature Flagging

**Section**: 8 (Rollout Plan)  
**Subsection**: 8.1, 8.2, 8.3  
**Task ID**: TASK-EML-011

## Description

This task involves implementing a feature flag system for Gmail MCP integration and creating a comprehensive rollout plan that enables controlled deployment across development, staging, and production environments. The feature flag allows operators to quickly enable/disable Gmail integration without code changes.

This ensures safe, gradual rollout of Gmail functionality with the ability to quickly rollback if issues occur.

**Reference Implementation**: 
- `cursor-runner/src/system-settings.ts` (for feature flag patterns)
- `cursor-runner/mcp.json` (for conditional MCP config)
- `cursor-runner/docker-compose.yml` (for environment-specific config)
- TASK-EML-004: MCP config structure
- TASK-EML-010: Security review findings

## Current State

- **Gmail MCP Configured**: TASK-EML-004 registered Gmail MCP in `mcp.json`
- **No Feature Flag**: Gmail MCP is always included in config (if present)
- **No Rollout Plan**: No documented procedure for enabling Gmail in different environments
- **Environments Exist**: Dev, staging, and production environments need different configs
- **Dependencies**: 
  - TASK-EML-004: MCP config should exist
  - TASK-EML-005: Env vars should be wired
  - TASK-EML-010: Security review should be complete

**Important**: This task should be completed before production deployment to enable controlled rollout.

## Checklist

### Preparation and Setup

- [ ] Review `cursor-runner/src/system-settings.ts` to understand settings patterns
- [ ] Review `cursor-runner/mcp.json` to understand MCP config structure
- [ ] Review `cursor-runner/docker-compose.yml` (if exists) for env-specific config patterns
- [ ] Review TASK-EML-004 output to understand MCP config loading
- [ ] Review TASK-EML-010 output for security considerations
- [ ] Understand how MCP config is loaded (static file vs dynamic loading)

### Implementation Steps

- [ ] Step 1: Add feature flag to system settings
  - [ ] Update `cursor-runner/src/system-settings.ts`:
    - [ ] Add `ENABLE_GMAIL_MCP` env var (default: `false` for safety)
    - [ ] Add getter method: `getGmailMcpEnabled(): boolean`
    - [ ] Follow existing patterns for feature flags
  - [ ] Update `cursor-runner/.env.example`:
    - [ ] Add `ENABLE_GMAIL_MCP=false` with comment explaining usage
- [ ] Step 2: Implement conditional MCP config
  - [ ] Identify where `mcp.json` is loaded (may be in server startup or MCP config loader)
  - [ ] Update MCP config loading logic to:
    - [ ] Read `ENABLE_GMAIL_MCP` from system settings
    - [ ] Conditionally include `gmail` entry in MCP config only if flag is `true`
    - [ ] Log whether Gmail MCP is enabled or disabled
  - [ ] Options for implementation:
    - [ ] Option A: Load `mcp.json` as template, conditionally add `gmail` entry
    - [ ] Option B: Have separate `mcp.json` files (mcp.json, mcp-with-gmail.json)
    - [ ] Option C: Generate MCP config dynamically based on feature flags
  - [ ] Choose approach that fits existing patterns
- [ ] Step 3: Configure per environment
  - [ ] Update `cursor-runner/docker-compose.yml` (if exists) with environment-specific configs:
    - [ ] Dev environment: `ENABLE_GMAIL_MCP=true` (default for developers)
    - [ ] Staging environment: `ENABLE_GMAIL_MCP=true` (with test Gmail credentials)
    - [ ] Production environment: `ENABLE_GMAIL_MCP=false` (default off, enable when ready)
  - [ ] Or document how to set flag per environment in deployment configs
  - [ ] Update `.env.example` with comments explaining per-environment usage
- [ ] Step 4: Create rollout documentation
  - [ ] Create `assistant-integrations/cursor-runner/plan/email/rollout-gmail.md`
  - [ ] Document rollout phases:
    - [ ] Phase 1: Dev only
      - [ ] Enable in dev environment
      - [ ] Manual testing with test Gmail account
      - [ ] Validate all flows work
    - [ ] Phase 2: Staging
      - [ ] Enable in staging with test Gmail account
      - [ ] Run integration tests
      - [ ] Validate reliability and error handling
    - [ ] Phase 3: Production
      - [ ] Enable in production with production Gmail account
      - [ ] Monitor for issues
      - [ ] Have rollback plan ready
  - [ ] Document rollback procedure:
    - [ ] Set `ENABLE_GMAIL_MCP=false`
    - [ ] Restart cursor-runner service
    - [ ] Verify Gmail MCP is disabled
    - [ ] Document any cleanup needed
- [ ] Step 5: Add verification test
  - [ ] Create test or script that verifies feature flag behavior:
    - [ ] Test with `ENABLE_GMAIL_MCP=true` → Gmail entry should be in MCP config
    - [ ] Test with `ENABLE_GMAIL_MCP=false` → Gmail entry should not be in MCP config
    - [ ] Test default behavior (should be disabled)
  - [ ] Add to test suite or create standalone verification script

### Specific Requirements

- [ ] Requirement 1: Feature Flag Implementation
  - [ ] **Acceptance Criteria**: `ENABLE_GMAIL_MCP` env var exists in `system-settings.ts`
  - [ ] **Acceptance Criteria**: Getter method `getGmailMcpEnabled()` returns boolean
  - [ ] **Acceptance Criteria**: Default value is `false` (safe default)
  - [ ] **Acceptance Criteria**: Flag is documented in `.env.example`
- [ ] Requirement 2: Conditional MCP Config
  - [ ] **Acceptance Criteria**: MCP config loading respects `ENABLE_GMAIL_MCP` flag
  - [ ] **Acceptance Criteria**: Gmail entry is included only when flag is `true`
  - [ ] **Acceptance Criteria**: Logging indicates whether Gmail MCP is enabled
  - [ ] **Acceptance Criteria**: Config works correctly in both states
- [ ] Requirement 3: Environment Configuration
  - [ ] **Acceptance Criteria**: Dev environment has flag enabled by default (or documented)
  - [ ] **Acceptance Criteria**: Staging environment has flag configurable with test credentials
  - [ ] **Acceptance Criteria**: Production environment has flag default off
  - [ ] **Acceptance Criteria**: Per-environment config is documented
- [ ] Requirement 4: Rollout Documentation
  - [ ] **Acceptance Criteria**: Rollout plan documents all phases
  - [ ] **Acceptance Criteria**: Rollback procedure is documented
  - [ ] **Acceptance Criteria**: Verification steps are included

### Error Handling and Edge Cases

- [ ] Handle missing `ENABLE_GMAIL_MCP` env var: Default to `false` (safe)
- [ ] Handle invalid flag value: Treat as `false`, log warning
- [ ] Handle flag change at runtime: May require restart (document this)
- [ ] Handle MCP config loading errors: Log error, don't crash

### Testing

- [ ] Write unit test for feature flag:
  - [ ] Test `getGmailMcpEnabled()` returns `true` when env var is `true`
  - [ ] Test `getGmailMcpEnabled()` returns `false` when env var is `false`
  - [ ] Test `getGmailMcpEnabled()` returns `false` when env var is missing (default)
  - [ ] Test `getGmailMcpEnabled()` returns `false` when env var is invalid
- [ ] Write integration test for conditional MCP config:
  - [ ] Test MCP config includes Gmail when flag is `true`
  - [ ] Test MCP config excludes Gmail when flag is `false`
  - [ ] Test logging indicates correct state
- [ ] Write verification script (optional but recommended):
  - [ ] Script checks MCP config based on flag
  - [ ] Script can be run to verify configuration
- [ ] Run full test suite: `npm test` in `cursor-runner`
- [ ] Run type checking: `npm run type-check` (if applicable)
- [ ] Run linting: `npm run lint`
- [ ] Verify test coverage: `npm run test:coverage` (if applicable)
- [ ] **DO NOT manually test by running the server** - use automated tests instead

### Documentation

- [ ] Update `cursor-runner/src/system-settings.ts` with feature flag
- [ ] Update `cursor-runner/.env.example` with flag and documentation
- [ ] Update MCP config loading code with conditional logic
- [ ] Create `assistant-integrations/cursor-runner/plan/email/rollout-gmail.md` with:
  - [ ] Rollout phases (dev, staging, production)
  - [ ] Per-environment configuration
  - [ ] Rollback procedure
  - [ ] Verification steps
  - [ ] Monitoring recommendations
- [ ] Update `cursor-runner/README.md` or relevant docs with feature flag usage
- [ ] Add code comments explaining feature flag logic

### Verification

- [ ] Verify feature flag works correctly
- [ ] Verify conditional MCP config works
- [ ] Verify per-environment config is documented
- [ ] Verify rollout plan is complete
- [ ] Verify all tests pass
- [ ] Verify no regressions

## Notes

- This task is part of the **Email Integration Master Plan - Phase 3: Security and Rollout**
- **Execution Timing**: Should be completed before production deployment, after security review
- **Dependencies**: 
  - TASK-EML-004: MCP config should exist
  - TASK-EML-005: Env vars should be wired
  - TASK-EML-010: Security review should be complete
- **Important Considerations**: 
  - Feature flag default should be `false` (safe default)
  - Rollout should be gradual (dev → staging → production)
  - Rollback should be quick and easy
  - Per-environment config is essential
  - Monitoring should be in place for production
  - Consider canary deployment if applicable
- **Task Independence**: Can be completed independently after dependencies
- **Current State**: No feature flag exists; Gmail MCP is always included if configured

## Related Tasks

- Previous: TASK-EML-010 (Security Review)
- Next: None (this is the final implementation task)
- Dependencies:
  - TASK-EML-004: Provides MCP config to make conditional
  - TASK-EML-005: Provides env var wiring
  - TASK-EML-010: Provides security validation
- Related:
  - TASK-EML-004: Feature flag controls whether Gmail entry is included
  - TASK-EML-005: Feature flag may affect startup validation

## Definition of Done

This is a **CODE/FILE WRITING TASK** (Type 1) with **CONFIGURATION TASK** (Type 5) components.

### User Stories Validation

- [ ] **As a release manager**: A controlled rollout plan exists enabling gradual deployment across dev, staging, and production with clear procedures and rollback capability
- [ ] **As an operator**: Gmail integration can be quickly enabled or disabled via feature flag without code changes, enabling rapid response to issues

### Code Implementation Requirements

- [ ] `cursor-runner/src/system-settings.ts` includes:
  - [ ] `ENABLE_GMAIL_MCP` env var (default: `false`)
  - [ ] Getter method `getGmailMcpEnabled(): boolean`
  - [ ] Follows existing feature flag patterns
- [ ] MCP config loading logic (wherever `mcp.json` is loaded) includes:
  - [ ] Check for `ENABLE_GMAIL_MCP` flag
  - [ ] Conditionally include `gmail` entry only if flag is `true`
  - [ ] Logging indicates whether Gmail MCP is enabled
- [ ] `cursor-runner/.env.example` includes:
  - [ ] `ENABLE_GMAIL_MCP=false` with documentation
  - [ ] Comments explaining per-environment usage
- [ ] `cursor-runner/docker-compose.yml` (if exists) includes:
  - [ ] Environment-specific `ENABLE_GMAIL_MCP` values
  - [ ] Or documentation on how to set per environment

### Automated Tests

- [ ] Unit test for feature flag:
  - [ ] Test returns `true` when env var is `true`
  - [ ] Test returns `false` when env var is `false`
  - [ ] Test returns `false` when env var is missing (default)
  - [ ] Test returns `false` when env var is invalid
- [ ] Integration test for conditional MCP config:
  - [ ] Test MCP config includes Gmail when flag is `true`
  - [ ] Test MCP config excludes Gmail when flag is `false`
  - [ ] Test logging indicates correct state
- [ ] Verification script (optional):
  - [ ] Script verifies MCP config based on flag
  - [ ] Script can be run to check configuration
- [ ] All existing tests in `cursor-runner` still pass: `npm test`
- [ ] Type checking passes: `npm run type-check` (if applicable)
- [ ] Linting passes: `npm run lint`
- [ ] Test coverage meets project requirements (if applicable)

### Documentation Requirements

- [ ] `assistant-integrations/cursor-runner/plan/email/rollout-gmail.md` exists with:
  - [ ] Rollout phases:
    - [ ] Phase 1: Dev only (enable, test, validate)
    - [ ] Phase 2: Staging (enable, test, validate reliability)
    - [ ] Phase 3: Production (enable with monitoring, rollback plan)
  - [ ] Per-environment configuration:
    - [ ] Dev: flag enabled by default
    - [ ] Staging: flag enabled with test credentials
    - [ ] Production: flag default off, enable when ready
  - [ ] Rollback procedure:
    - [ ] Set `ENABLE_GMAIL_MCP=false`
    - [ ] Restart service
    - [ ] Verify Gmail MCP is disabled
    - [ ] Cleanup steps (if any)
  - [ ] Verification steps
  - [ ] Monitoring recommendations
- [ ] `cursor-runner/.env.example` documents feature flag usage
- [ ] Code comments explain feature flag logic

### Git Commit and Push

- [ ] Planning doc committed to `assistant-integrations/cursor-runner` repository:
  - [ ] Commit message: `docs(email): add gmail mcp rollout plan`
  - [ ] File: `assistant-integrations/cursor-runner/plan/email/rollout-gmail.md` (new file)
  - [ ] Push to origin: `git push origin <branch-name>`
- [ ] Implementation committed to `cursor-runner` repository:
  - [ ] Commit message: `feat(email): add gmail mcp feature flag and rollout plan`
  - [ ] Files modified:
    - [ ] `cursor-runner/src/system-settings.ts` (feature flag)
    - [ ] MCP config loading code (conditional logic)
    - [ ] `cursor-runner/.env.example` (flag documentation)
    - [ ] `cursor-runner/docker-compose.yml` (if env configs added)
    - [ ] `cursor-runner/tests/test_system_settings.test.ts` (feature flag tests)
    - [ ] `cursor-runner/tests/test_mcp_config.test.ts` (conditional config tests)
  - [ ] Push to origin: `git push origin <branch-name>`
- [ ] Both commits are verified in remote repositories

### Final Verification

- [ ] Feature flag is implemented and working
- [ ] Conditional MCP config works correctly
- [ ] Per-environment configuration is documented
- [ ] Rollout plan is complete and actionable
- [ ] Rollback procedure is documented
- [ ] All tests pass
- [ ] No regressions introduced
- [ ] Documentation is complete
- [ ] Task completes the Gmail integration implementation
