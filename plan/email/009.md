# TASK-EML-009: Optional Live Gmail Smoke Test (Non-CI)

**Section**: 7.5 (Optional smoke tests)  
**Subsection**: 7.5  
**Task ID**: TASK-EML-009

## Description

This task involves creating an optional, opt-in smoke test that exercises a real Gmail account via Gmail MCP to catch configuration issues, OAuth scope problems, or other real-world issues before production deployment. This test is explicitly **not** run in CI by default and requires manual execution with proper Gmail credentials.

This complements the mocked integration tests from TASK-EML-008 by validating against a real Gmail account.

**Reference Implementation**: 
- `cursor-runner/scripts/` (for script patterns)
- `cursor-runner/tests/` (for test patterns, but this will be a script)
- TASK-EML-007 output (`flows-gmail.md`) for test scenarios

## Current State

- **No Live Tests**: No tests exist that hit real Gmail accounts
- **Mocked Tests Exist**: TASK-EML-008 provides mocked integration tests
- **Gmail MCP Configured**: TASK-EML-004 and TASK-EML-005 should have Gmail MCP working
- **Test Account Needed**: A dedicated test Gmail account should be available
- **Dependencies**: 
  - TASK-EML-004: Gmail MCP must be configured
  - TASK-EML-005: Env vars must be wired
  - TASK-EML-008: Mocked tests should exist first

**Important**: This test must be explicitly opt-in (not run in CI) and should only perform safe, read-only operations on a test Gmail account.

## Checklist

### Preparation and Setup

- [ ] Review `cursor-runner/scripts/` to understand script patterns
- [ ] Review TASK-EML-007 output (`flows-gmail.md`) for safe test scenarios
- [ ] Set up dedicated test Gmail account (separate from production)
- [ ] Configure test Gmail account with OAuth credentials
- [ ] Verify Gmail MCP can connect to test account (manual verification)
- [ ] Understand what read-only operations are safe to test

### Implementation Steps

- [ ] Step 1: Create smoke test script
  - [ ] Create `cursor-runner/scripts/gmail_smoke_test.ts` (or `.js`)
  - [ ] Script should:
    - [ ] Check for `ENABLE_GMAIL_SMOKE_TEST=1` env var (guard)
    - [ ] Verify Gmail env vars are set
    - [ ] Connect to Gmail MCP server
    - [ ] Perform safe read-only operations:
      - [ ] List Gmail labels (safe, no data modification)
      - [ ] Read a known test label (if exists)
      - [ ] Get message count for a label
    - [ ] Log results clearly
    - [ ] Exit with appropriate code (0 for success, non-zero for failure)
- [ ] Step 2: Add npm script (optional)
  - [ ] Add to `cursor-runner/package.json`:
    - [ ] `"test:gmail:smoke": "ENABLE_GMAIL_SMOKE_TEST=1 node scripts/gmail_smoke_test.js"`
  - [ ] Document that this requires Gmail credentials
- [ ] Step 3: Document usage
  - [ ] Update `cursor-runner/README.md` or create `cursor-runner/docs/gmail-smoke-test.md`
  - [ ] Document:
    - [ ] How to set up test Gmail account
    - [ ] How to configure credentials
    - [ ] How to run the smoke test
    - [ ] What the test does (read-only operations)
    - [ ] When to run it (before production deployment)
    - [ ] How to interpret results
- [ ] Step 4: Ensure CI exclusion
  - [ ] Verify script checks `ENABLE_GMAIL_SMOKE_TEST` env var
  - [ ] Verify CI doesn't set this flag by default
  - [ ] Add comment in CI config (if applicable) noting this test is opt-in
  - [ ] Document that this test should not run in CI

### Specific Requirements

- [ ] Requirement 1: Smoke Test Script
  - [ ] **Acceptance Criteria**: Script exists at `cursor-runner/scripts/gmail_smoke_test.ts` (or `.js`)
  - [ ] **Acceptance Criteria**: Script checks `ENABLE_GMAIL_SMOKE_TEST=1` before running
  - [ ] **Acceptance Criteria**: Script performs safe read-only operations only
  - [ ] **Acceptance Criteria**: Script provides clear success/failure output
- [ ] Requirement 2: Safety
  - [ ] **Acceptance Criteria**: Test only performs read-only operations
  - [ ] **Acceptance Criteria**: Test uses dedicated test Gmail account
  - [ ] **Acceptance Criteria**: Test doesn't modify any Gmail data
  - [ ] **Acceptance Criteria**: Test is clearly marked as non-CI
- [ ] Requirement 3: Documentation
  - [ ] **Acceptance Criteria**: Usage instructions are documented
  - [ ] **Acceptance Criteria**: Setup steps are clear
  - [ ] **Acceptance Criteria**: Test is marked as optional and non-CI

### Error Handling and Edge Cases

- [ ] Handle missing `ENABLE_GMAIL_SMOKE_TEST` flag: Script should exit immediately with clear message
- [ ] Handle missing Gmail env vars: Script should fail with clear error
- [ ] Handle Gmail MCP connection failure: Script should report error clearly
- [ ] Handle OAuth authentication failure: Script should report auth error
- [ ] Handle test account not configured: Script should report setup needed

### Testing

- [ ] Manual testing: Run smoke test against test Gmail account
  - [ ] Verify test succeeds with proper credentials
  - [ ] Verify test fails gracefully with missing credentials
  - [ ] Verify test doesn't run without `ENABLE_GMAIL_SMOKE_TEST=1`
- [ ] Verify script doesn't run in CI (check CI config)
- [ ] No automated unit tests required (this is a manual smoke test script)

### Documentation

- [ ] Create or update documentation:
  - [ ] `cursor-runner/README.md` (add smoke test section)
  - [ ] Or `cursor-runner/docs/gmail-smoke-test.md` (dedicated doc)
- [ ] Document:
  - [ ] Purpose of smoke test
  - [ ] Setup requirements (test Gmail account, credentials)
  - [ ] How to run: `ENABLE_GMAIL_SMOKE_TEST=1 npm run test:gmail:smoke` (or equivalent)
  - [ ] What operations it performs (read-only, safe)
  - [ ] When to run it (before production deployment)
  - [ ] How to interpret results
  - [ ] Troubleshooting common issues
- [ ] Add code comments in script explaining each step

### Verification

- [ ] Verify script exists and is executable
- [ ] Verify script checks for opt-in flag
- [ ] Verify script performs only read-only operations
- [ ] Verify documentation is complete
- [ ] Verify script doesn't run in CI

## Notes

- This task is part of the **Email Integration Master Plan - Phase 2: Implementation**
- **Execution Timing**: Should be completed after TASK-EML-008, but can be done in parallel
- **Dependencies**: 
  - TASK-EML-004: Gmail MCP must be configured
  - TASK-EML-005: Env vars must be wired
  - TASK-EML-008: Mocked tests should exist first
- **Important Considerations**: 
  - **CRITICAL**: This test must be opt-in and never run in CI by default
  - Test should only perform read-only operations
  - Use dedicated test Gmail account, not production
  - Test should be fast (simple operations only)
  - Clear documentation is essential
- **Task Independence**: Can be completed independently after dependencies
- **Current State**: No live Gmail smoke test exists; this task creates it

## Related Tasks

- Previous: TASK-EML-008 (Integration Tests)
- Next: TASK-EML-010 (Security Review)
- Dependencies:
  - TASK-EML-004: Gmail MCP must be configured
  - TASK-EML-005: Env vars must be wired
  - TASK-EML-008: Mocked tests should exist first
- Related:
  - TASK-EML-008: Provides mocked tests; this provides live validation
  - TASK-EML-010: Security review will validate this test is safe

## Definition of Done

This is a **CODE/FILE WRITING TASK** (Type 1) with **TESTING TASK** (Type 4) components.

### User Stories Validation

- [ ] **As a maintainer**: A manual or gated test exists that exercises a real Gmail account to catch configuration or scope issues before production, enabling confidence in deployment

### Code Implementation Requirements

- [ ] `cursor-runner/scripts/gmail_smoke_test.ts` (or `.js`) exists with:
  - [ ] Check for `ENABLE_GMAIL_SMOKE_TEST=1` env var (exits if not set)
  - [ ] Verification of Gmail env vars
  - [ ] Connection to Gmail MCP server
  - [ ] Safe read-only operations (list labels, read test label, get message count)
  - [ ] Clear logging of results
  - [ ] Appropriate exit codes (0 for success, non-zero for failure)
- [ ] Script is executable and properly formatted
- [ ] Script includes code comments explaining each step

### Safety Requirements

- [ ] Script only performs read-only operations:
  - [ ] List Gmail labels
  - [ ] Read messages from a test label (if exists)
  - [ ] Get message counts
  - [ ] No write operations (send, delete, modify)
- [ ] Script uses dedicated test Gmail account (not production)
- [ ] Script is clearly marked as non-CI and opt-in
- [ ] Script checks opt-in flag before running

### Documentation Requirements

- [ ] Documentation exists explaining:
  - [ ] Purpose of smoke test
  - [ ] Setup requirements (test Gmail account, OAuth credentials)
  - [ ] How to run: `ENABLE_GMAIL_SMOKE_TEST=1 npm run test:gmail:smoke` (or equivalent command)
  - [ ] What operations it performs (read-only, safe)
  - [ ] When to run it (before production deployment)
  - [ ] How to interpret results
  - [ ] Troubleshooting common issues
- [ ] Documentation clearly states test is optional and non-CI
- [ ] Code comments explain script functionality

### Manual Testing

- [ ] Smoke test is run manually against test Gmail account:
  - [ ] Test succeeds with proper credentials configured
  - [ ] Test fails gracefully with missing credentials
  - [ ] Test doesn't run without `ENABLE_GMAIL_SMOKE_TEST=1` flag
  - [ ] Test performs only read-only operations (verified)
- [ ] CI configuration verified to not run this test by default

### Git Commit and Push

- [ ] All changes are committed to `cursor-runner` repository:
  - [ ] Commit message: `chore(email): add optional live gmail smoke test`
  - [ ] Files created/modified:
    - [ ] `cursor-runner/scripts/gmail_smoke_test.ts` (or `.js`) (new file)
    - [ ] `cursor-runner/package.json` (if npm script added)
    - [ ] `cursor-runner/README.md` or `cursor-runner/docs/gmail-smoke-test.md` (documentation)
- [ ] Changes are pushed to origin: `git push origin <branch-name>`
- [ ] Push is verified (check remote repository to confirm)

### Final Verification

- [ ] Smoke test script exists and is executable
- [ ] Script checks for opt-in flag
- [ ] Script performs only read-only operations
- [ ] Script successfully connects to real Gmail account (manual test)
- [ ] Documentation is complete
- [ ] Script is clearly marked as non-CI
- [ ] Task is ready for TASK-EML-010 (security review) to proceed
