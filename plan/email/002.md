# TASK-EML-002: Define Gmail Secrets and Configuration Contract

**Section**: 3 (Configuration & Secrets)  
**Subsection**: 3.1, 3.2, 3.3  
**Task ID**: TASK-EML-002

## Description

This task involves designing and documenting the complete configuration contract for Gmail MCP integration, including all required environment variables, OAuth scopes, security constraints, and where these must be set across different environments (local dev, Docker, production). The output will be a design document and implementation in `cursor-runner` that defines how Gmail credentials are managed securely.

This establishes the foundation for all Gmail-related configuration in subsequent tasks, ensuring consistent and secure credential handling.

**Reference Implementation**: 
- `cursor-runner/.env.example` (for env var patterns)
- `cursor-runner/src/system-settings.ts` (for settings management patterns)
- Gmail OAuth documentation (for scope requirements)

## Current State

- **No Gmail Configuration**: No Gmail-related environment variables or configuration exist in `cursor-runner`
- **Existing Env Pattern**: `cursor-runner` uses `.env.example` and `system-settings.ts` for configuration management
- **No OAuth Setup**: No OAuth credential mechanism is currently configured for Gmail
- **Security Baseline**: Existing patterns for handling secrets (e.g., `CURSOR_API_KEY`) can be referenced
- **Dependencies**: TASK-EML-001 should be completed to understand current env var patterns

**Important**: This task must be completed before TASK-EML-003 (adding Gmail MCP dependency) and TASK-EML-005 (wiring env vars), as it defines what needs to be configured.

## Checklist

### Preparation and Setup

- [ ] Review `cursor-runner/.env.example` to understand existing env var patterns
- [ ] Review `cursor-runner/src/system-settings.ts` to understand how settings are loaded and validated
- [ ] Research Gmail MCP server requirements (OAuth scopes, credential types)
- [ ] Review Gmail OAuth documentation for required scopes and best practices
- [ ] Review security best practices for OAuth refresh tokens vs service accounts
- [ ] Understand how secrets are managed in production (secret managers, etc.)
- [ ] Review TASK-EML-001 output (`current-state.md`) for env var flow patterns

### Implementation Steps

- [ ] Step 1: Choose credential mechanism
  - [ ] Research OAuth refresh token approach (user consent, token refresh)
  - [ ] Research service account approach (service-to-service, no user consent)
  - [ ] Evaluate which approach fits cursor-runner's use case
  - [ ] Document decision and rationale in design doc
- [ ] Step 2: Define environment variables
  - [ ] List all required `GMAIL_*` env vars:
    - [ ] `GMAIL_CLIENT_ID` (OAuth client ID)
    - [ ] `GMAIL_CLIENT_SECRET` (OAuth client secret)
    - [ ] `GMAIL_REFRESH_TOKEN` (OAuth refresh token, if using refresh token approach)
    - [ ] `GMAIL_SERVICE_ACCOUNT_KEY` (service account JSON, if using service account approach)
    - [ ] `GMAIL_USER_EMAIL` (target Gmail account email, if needed)
    - [ ] `GMAIL_ALLOWED_LABELS` (optional: restrict to specific labels)
  - [ ] Define which vars are required vs optional
  - [ ] Define default values where applicable
  - [ ] Document validation rules (format, length, etc.)
- [ ] Step 3: Define OAuth scopes
  - [ ] Research minimal required scopes for Gmail MCP operations:
    - [ ] `gmail.readonly` (for reading emails)
    - [ ] `gmail.send` (for sending/drafting replies)
    - [ ] `gmail.modify` (for labeling, archiving - if needed)
  - [ ] Document scope rationale (why each scope is needed)
  - [ ] Document least-privilege approach (request only what's needed)
  - [ ] Note any scope limitations or restrictions
- [ ] Step 4: Create design document
  - [ ] Create `assistant-integrations/cursor-runner/plan/email/config.md`
  - [ ] Document credential mechanism choice and rationale
  - [ ] Document all `GMAIL_*` env vars with descriptions, required/optional status, examples
  - [ ] Document OAuth scopes with rationale
  - [ ] Document where env vars must be set (local `.env`, Docker compose, production secrets)
  - [ ] Document security constraints (least privilege, token rotation, etc.)
  - [ ] Document how to obtain credentials (OAuth flow steps, service account creation)
- [ ] Step 5: Implement in cursor-runner
  - [ ] Add `GMAIL_*` env vars to `cursor-runner/.env.example` with placeholder values
  - [ ] Update `cursor-runner/src/system-settings.ts` to:
    - [ ] Add getter methods for Gmail env vars (if needed for validation)
    - [ ] Add validation logic if required (e.g., format checks)
    - [ ] Follow existing patterns for other API keys
  - [ ] Add comments/documentation in code referencing the design doc

### Specific Requirements

- [ ] Requirement 1: Complete Environment Variable Contract
  - [ ] **Acceptance Criteria**: All `GMAIL_*` env vars are defined with clear descriptions
  - [ ] **Acceptance Criteria**: Required vs optional vars are clearly marked
  - [ ] **Acceptance Criteria**: Example values are provided (with placeholders, not real secrets)
  - [ ] **Acceptance Criteria**: Validation rules are documented
- [ ] Requirement 2: OAuth Scope Documentation
  - [ ] **Acceptance Criteria**: All required OAuth scopes are listed with rationale
  - [ ] **Acceptance Criteria**: Least-privilege approach is documented
  - [ ] **Acceptance Criteria**: Scope limitations or restrictions are noted
- [ ] Requirement 3: Security Constraints
  - [ ] **Acceptance Criteria**: Document explicitly states secrets must not be hard-coded
  - [ ] **Acceptance Criteria**: Token rotation procedures are documented
  - [ ] **Acceptance Criteria**: Revocation procedures are documented
  - [ ] **Acceptance Criteria**: Least-privilege principle is emphasized
- [ ] Requirement 4: Implementation in cursor-runner
  - [ ] **Acceptance Criteria**: `cursor-runner/.env.example` includes all `GMAIL_*` vars with placeholders
  - [ ] **Acceptance Criteria**: `cursor-runner/src/system-settings.ts` includes Gmail config (if validation needed)
  - [ ] **Acceptance Criteria**: Code follows existing patterns for other API keys

### Error Handling and Edge Cases

- [ ] Handle missing required env vars: Document what happens and how to detect
- [ ] Handle invalid env var formats: Document validation rules and error messages
- [ ] Handle expired refresh tokens: Document refresh procedure
- [ ] Handle revoked credentials: Document detection and recovery
- [ ] Handle different credential types: Document how to switch between OAuth and service account

### Testing

- [ ] Write unit tests for `system-settings.ts` Gmail config (if validation logic added):
  - [ ] Test with all required env vars present
  - [ ] Test with missing required env vars (should handle gracefully)
  - [ ] Test with invalid env var formats (if validation added)
  - [ ] Test default values (if any)
- [ ] Run full test suite: `npm test` in `cursor-runner`
- [ ] Run type checking: `npm run type-check` (if applicable)
- [ ] Run linting: `npm run lint`
- [ ] Verify test coverage: `npm run test:coverage` (if applicable)
- [ ] **DO NOT manually test by running the server** - use automated tests instead

### Documentation

- [ ] Create `assistant-integrations/cursor-runner/plan/email/config.md` with complete configuration contract
- [ ] Update `cursor-runner/.env.example` with Gmail env vars
- [ ] Update `cursor-runner/src/system-settings.ts` with Gmail config (if validation needed)
- [ ] Add code comments referencing the design doc
- [ ] Document credential acquisition process (OAuth flow or service account setup)
- [ ] Document security best practices and constraints

### Verification

- [ ] Verify all Gmail env vars are documented and implemented
- [ ] Verify OAuth scopes are documented with rationale
- [ ] Verify security constraints are clearly stated
- [ ] Verify code follows existing patterns
- [ ] Verify no regressions in existing functionality
- [ ] Verify design doc is complete and actionable

## Notes

- This task is part of the **Email Integration Master Plan - Phase 1: Discovery and Planning**
- **Execution Timing**: Must be completed after TASK-EML-001 and before TASK-EML-003 and TASK-EML-005
- **Dependencies**: 
  - TASK-EML-001: Need to understand current env var patterns
- **Important Considerations**: 
  - Security is critical - never hard-code secrets
  - Follow least-privilege for OAuth scopes
  - Document token rotation procedures
  - Consider both development and production environments
  - Design should be flexible enough to support different credential types if needed
- **Task Independence**: Can be completed independently after TASK-EML-001
- **Current State**: No Gmail configuration exists; this task establishes the contract

## Related Tasks

- Previous: TASK-EML-001 (Inventory Current Email/MCP Capabilities)
- Next: TASK-EML-003 (Add Gmail MCP Dependency), TASK-EML-005 (Wire Gmail Env Vars)
- Dependencies:
  - TASK-EML-001: Provides baseline understanding of env var patterns
- Related:
  - TASK-EML-003: Will use this contract to know what Gmail MCP server needs
  - TASK-EML-005: Will use this contract to wire env vars correctly
  - TASK-EML-010: Security review will validate this contract

## Definition of Done

This is a **DOCUMENTATION TASK** (Type 3) with **CONFIGURATION TASK** (Type 5) components.

### User Stories Validation

- [ ] **As an operator**: The configuration contract provides a single, clear definition of all Gmail-related env vars, their purposes, and where they must be set, enabling safe configuration across environments
- [ ] **As a security engineer**: The contract ensures Gmail secrets are not hard-coded, follows least-privilege principles, and documents security constraints clearly

### Documentation Requirements

- [ ] `assistant-integrations/cursor-runner/plan/email/config.md` exists and contains:
  - [ ] Credential mechanism choice (OAuth vs service account) with rationale
  - [ ] Complete list of all `GMAIL_*` env vars with descriptions, required/optional status, examples
  - [ ] OAuth scopes with rationale and least-privilege approach
  - [ ] Security constraints (no hard-coding, token rotation, revocation procedures)
  - [ ] Instructions for obtaining credentials (OAuth flow or service account setup)
  - [ ] Where env vars must be set (local `.env`, Docker compose, production secrets)
- [ ] `cursor-runner/.env.example` includes all `GMAIL_*` env vars with placeholder values
- [ ] `cursor-runner/src/system-settings.ts` includes Gmail config (if validation logic is needed)

### Automated Tests

- [ ] Unit tests exist for Gmail config in `system-settings.ts` (if validation logic added):
  - [ ] Test with all required env vars present
  - [ ] Test with missing required env vars
  - [ ] Test with invalid env var formats (if validation added)
- [ ] All existing tests in `cursor-runner` still pass: `npm test`
- [ ] Type checking passes: `npm run type-check` (if applicable)
- [ ] Linting passes: `npm run lint`
- [ ] Test coverage meets project requirements (if applicable)

### Git Commit and Push

- [ ] Planning doc committed to `assistant-integrations/cursor-runner` repository:
  - [ ] Commit message: `docs(email): define gmail env and scope contract`
  - [ ] File: `assistant-integrations/cursor-runner/plan/email/config.md`
  - [ ] Push to origin: `git push origin <branch-name>`
- [ ] Implementation committed to `cursor-runner` repository:
  - [ ] Commit message: `feat(email): add gmail env vars to system settings`
  - [ ] Files: `cursor-runner/.env.example`, `cursor-runner/src/system-settings.ts` (if modified)
  - [ ] Push to origin: `git push origin <branch-name>`
- [ ] Both commits are verified in remote repositories

### Final Verification

- [ ] Design document exists and is complete
- [ ] `cursor-runner/.env.example` includes Gmail vars
- [ ] `cursor-runner/src/system-settings.ts` includes Gmail config (if needed)
- [ ] All tests pass
- [ ] No regressions introduced
- [ ] Task is ready for TASK-EML-003 and TASK-EML-005 to proceed
