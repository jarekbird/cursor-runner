# TASK-PY-007: Implement Filesystem & File Tree Services

**Section**: 4. Core Services
**Subsection**: 4.1
**Task ID**: TASK-PY-007

## Description

This task implements filesystem and file tree services that provide safe, repository-scoped file operations and directory tree generation. These services are critical for security (preventing path traversal attacks) and for providing file browsing capabilities to the API.

The filesystem service provides safe read/write operations with path validation, while the file tree service builds nested directory structures with ignore rules and sorted output. Both must match Node.js behavior exactly, including edge case handling.

**Reference Implementation**: `VirtualAssistant/cursor-runner/src/filesystem-service.ts`, `VirtualAssistant/cursor-runner/src/file-tree-service.ts`

## Current State

- TASK-PY-006 has been completed, providing database services
- System settings exist with `repositories_path` configuration
- No filesystem abstraction exists yet
- No file tree generation exists yet
- Path validation and security checks don't exist

**Important**: This task should be executed after TASK-PY-006 and before TASK-PY-008 (workspace trust) which will integrate with these services.

## Checklist

### Preparation and Setup

- [ ] Review Node.js `filesystem-service.ts` to understand safe path operations
- [ ] Review Node.js `file-tree-service.ts` to understand tree building and ignore rules
- [ ] Review Node.js tests to understand edge cases
- [ ] Understand path traversal attack vectors and prevention
- [ ] Review ignore patterns used in Node.js (node_modules, .git, etc.)

### Implementation Steps

- [ ] Step 1: Implement filesystem service
  - [ ] Create `cursor_executor/services/filesystem_service.py`:
    - [ ] `exists(path: str) -> bool`: Check if path exists
    - [ ] `read_file(path: str, root: Optional[str] = None) -> str`: Read file safely
      - [ ] Resolve path using `pathlib.Path.resolve()`
      - [ ] Validate path is within root directory (if provided)
      - [ ] Raise error on path traversal attempts
      - [ ] Handle file not found errors
      - [ ] Handle permission errors
    - [ ] `write_file(path: str, content: str, root: Optional[str] = None) -> None`: Write file safely
      - [ ] Resolve path and validate
      - [ ] Create parent directories if needed
      - [ ] Write file with proper error handling
    - [ ] `is_within_root(path: str, root: str) -> bool`: Check if path is within root
      - [ ] Use `pathlib.Path.resolve()` for both paths
      - [ ] Compare resolved paths
      - [ ] Return True if path is within root
    - [ ] Support dependency injection for testing (like Node.js)
- [ ] Step 2: Implement file tree service
  - [ ] Create `cursor_executor/services/file_tree_service.py`:
    - [ ] `build_file_tree(dir_path: str, max_depth: int = 10) -> List[FileNode]`: Build tree
      - [ ] Recursively walk directory
      - [ ] Apply ignore rules
      - [ ] Sort output (directories first, then files)
      - [ ] Limit depth to max_depth
      - [ ] Return FileNode list
    - [ ] `should_ignore(name: str) -> bool`: Check if name should be ignored
      - [ ] Check against ignore patterns (node_modules, .git, __pycache__, etc.)
      - [ ] Support glob patterns
      - [ ] Match Node.js ignore behavior
    - [ ] Define `FileNode` dataclass or Pydantic model:
      - [ ] `name: str`
      - [ ] `path: str`
      - [ ] `type: str` ("file" or "directory")
      - [ ] `children: Optional[List[FileNode]]` (for directories)
    - [ ] Sort directories before files, then alphabetically
- [ ] Step 3: Add error handling
  - [ ] Handle path traversal attempts (raise SecurityError)
  - [ ] Handle non-existent paths (raise FileNotFoundError)
  - [ ] Handle permission errors (raise PermissionError)
  - [ ] Handle invalid paths (raise ValueError)
  - [ ] Log errors appropriately

### Specific Requirements

- [ ] Requirement 1: Path security
  - Acceptance criteria: Path traversal attempts are blocked
  - Acceptance criteria: Paths are validated against root directory
  - Acceptance criteria: Resolved paths are used for validation
- [ ] Requirement 2: File tree matches Node.js behavior
  - Acceptance criteria: Ignore rules match Node.js
  - Acceptance criteria: Sorting matches Node.js (dirs first, then files)
  - Acceptance criteria: Max depth is respected
  - Acceptance criteria: FileNode structure matches Node.js
- [ ] Requirement 3: Error handling
  - Acceptance criteria: All error cases are handled gracefully
  - Acceptance criteria: Error messages are clear
  - Acceptance criteria: Security errors are logged

### Error Handling and Edge Cases

- [ ] Handle path traversal: `../` attempts blocked
- [ ] Handle symlinks: Resolve and validate
- [ ] Handle very deep directories: Respect max_depth
- [ ] Handle very large directories: Don't crash on large file lists
- [ ] Handle permission denied: Raise appropriate error
- [ ] Handle missing root directory: Raise error
- [ ] Handle empty directories: Return empty list

### Testing

- [ ] Write `tests/test_filesystem_service.py`:
  - [ ] Test path exists check
  - [ ] Test safe file read within root
  - [ ] Test safe file write within root
  - [ ] Test path traversal blocked (../ attempts)
  - [ ] Test path validation against root
  - [ ] Test file not found error
  - [ ] Test permission error handling
  - [ ] Test dependency injection for mocking
- [ ] Write `tests/test_file_tree_service.py`:
  - [ ] Test building file tree
  - [ ] Test ignore rules work correctly
  - [ ] Test sorting (directories first, then files)
  - [ ] Test max depth is respected
  - [ ] Test empty directory returns empty list
  - [ ] Test large directory doesn't crash
  - [ ] Test FileNode structure matches expected format
- [ ] Run `pytest tests/test_filesystem_service.py tests/test_file_tree_service.py -v`
- [ ] Verify test coverage is >85%
- [ ] **DO NOT manually test by running the server** - use automated tests

### Documentation

- [ ] Add docstrings to all functions
- [ ] Document security considerations
- [ ] Document ignore patterns
- [ ] Document FileNode structure

### Verification

- [ ] Verify path security works correctly
- [ ] Verify file tree generation matches Node.js
- [ ] Verify ignore rules work
- [ ] Verify error handling is robust
- [ ] Verify tests pass with >85% coverage

## Notes

- This task is part of Phase 4: Core Services
- **Execution Timing**: Execute after TASK-PY-006, before TASK-PY-008
- **Dependencies**: 
  - TASK-PY-003: System settings for repositories_path
- **Important Considerations**: 
  - Path security is critical - must prevent traversal attacks
  - Use `pathlib.Path.resolve()` for all path operations
  - Ignore rules should match Node.js exactly
  - File tree structure must match Node.js API contract
- **Task Independence**: Can be completed independently after settings exist
- **Current State**: No filesystem services exist yet

## Related Tasks

- Previous: TASK-PY-006 (Implement System Settings & Task Services)
- Next: TASK-PY-008 (Implement Workspace Trust Service)
- Dependencies:
  - TASK-PY-003: System settings needed
- Related:
  - TASK-PY-008: Will integrate with filesystem service
  - TASK-PY-014: HTTP API will use file tree service

## Definition of Done

This task involves **CODE/FILE WRITING**.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**User Stories**:
- As a **developer**, I need safe filesystem operations so paths are validated and secure
- As a **developer**, I need file tree generation so I can browse repository structures
- As a **security engineer**, I need path traversal protection so the system is secure

**Automated Tests**:
- `tests/test_filesystem_service.py`: Path security, read/write operations, error handling
- `tests/test_file_tree_service.py`: Tree building, ignore rules, sorting, max depth
- All tests pass with >85% coverage

**Commit and Push Requirements**:
- [ ] Commit: `git commit -m "TASK-PY-007: Implement filesystem and file tree services"`
- [ ] Push to origin
- [ ] Verify CI/CD passes

**Completion Criteria**:
- [ ] Filesystem service exists with path security
- [ ] File tree service exists with ignore rules and sorting
- [ ] Tests pass with >85% coverage
- [ ] Code committed and pushed
