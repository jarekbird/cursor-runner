# TASK-PY-003: Implement Configuration & Settings Module

**Section**: 2. Project Setup
**Subsection**: 2.2
**Task ID**: TASK-PY-003

## Description

This task implements a comprehensive configuration and settings module that loads and validates all environment variables needed by `cursor-executor`. The module uses `pydantic-settings` to provide type-safe, validated configuration with defaults that exactly match the Node.js `cursor-runner` behavior.

The settings module serves as the single source of truth for all configuration values, ensuring consistency across all services. It must handle:
- Loading from environment variables and `.env` files
- Type validation and conversion
- Default values matching Node.js implementation
- Required value validation with clear error messages
- Support for feature flags and optional integrations (Gmail MCP, ElevenLabs, etc.)

This module is foundational - all other services will depend on it for configuration, so it must be robust, well-tested, and complete.

**Reference Implementation**: `VirtualAssistant/cursor-runner/src/system-settings.ts`, `VirtualAssistant/cursor-runner/.env.example`

## Current State

- TASK-PY-002 has been completed, establishing the Python project skeleton
- FastAPI server exists with a basic health endpoint
- No configuration module exists yet
- Environment variables are not being loaded or validated
- Services cannot access typed configuration values
- No `.env.example` file exists for Python project

**Important**: This task should be executed after TASK-PY-002 (project skeleton) and before any service implementations that need configuration.

## Checklist

### Preparation and Setup

- [ ] Review Node.js `system-settings.ts` to understand all configuration options
- [ ] Review Node.js `.env.example` to identify all environment variables
- [ ] Review Node.js `docker-compose.yml` for environment variable defaults
- [ ] Identify which settings are required vs optional
- [ ] Identify which settings have defaults and what those defaults are
- [ ] Understand the difference between environment-based settings and database-backed settings (database-backed will come in TASK-PY-006)

### Implementation Steps

- [ ] Step 1: Create system settings module structure
  - [ ] Create `cursor_executor/services/system_settings.py`
  - [ ] Import required dependencies: `pydantic`, `pydantic_settings`, `pathlib`
  - [ ] Create `SystemSettings` class extending `BaseSettings` from `pydantic_settings`
  - [ ] Configure settings to read from `.env` file and environment variables
- [ ] Step 2: Implement server configuration settings
  - [ ] `port`: int (default: 3001)
  - [ ] `log_level`: str (default: "info")
  - [ ] `log_file`: Optional[str] (default: None)
  - [ ] `node_env`: str (default: "development")
  - [ ] `debug`: bool (default: False)
- [ ] Step 3: Implement Cursor CLI configuration settings
  - [ ] `cursor_cli_path`: str (default: "cursor")
  - [ ] `cursor_cli_timeout`: int (default: 300000, milliseconds)
  - [ ] `cursor_cli_max_concurrent`: int (default: 5)
  - [ ] `cursor_cli_max_output_size`: int (default: 10485760, 10MB)
  - [ ] `cursor_cli_idle_timeout`: int (default: 600000, 10 minutes)
  - [ ] `cursor_cli_iterate_timeout`: int (default: 900000, 15 minutes)
- [ ] Step 4: Implement terminal service configuration
  - [ ] `terminal_command_timeout`: int (default: 300000, milliseconds)
  - [ ] `terminal_max_output_size`: int (default: 10485760, 10MB)
- [ ] Step 5: Implement filesystem and workspace configuration
  - [ ] `target_app_path`: Optional[str] (default: None)
  - [ ] `repositories_path`: str (default: "/app/repositories")
  - [ ] `shared_db_path`: str (default: "/app/shared_db/shared.sqlite3")
- [ ] Step 6: Implement Redis configuration
  - [ ] `redis_url`: str (default: "redis://redis:6379/0")
- [ ] Step 7: Implement Git configuration
  - [ ] `github_token`: Optional[SecretStr] (default: None)
  - [ ] `git_token`: Optional[SecretStr] (default: None)
  - [ ] `github_username`: Optional[str] (default: None)
  - [ ] `git_username`: Optional[str] (default: None)
  - [ ] `git_user_name`: Optional[str] (default: None)
  - [ ] `git_user_email`: Optional[str] (default: None)
  - [ ] `github_email`: Optional[str] (default: None)
  - [ ] `github_ssh_key_path`: Optional[str] (default: None)
- [ ] Step 8: Implement integration and feature flag settings
  - [ ] `enable_gmail_mcp`: bool (default: False)
  - [ ] `gmail_client_id`: Optional[SecretStr] (default: None)
  - [ ] `gmail_client_secret`: Optional[SecretStr] (default: None)
  - [ ] `gmail_refresh_token`: Optional[SecretStr] (default: None)
  - [ ] `elevenlabs_agent_enabled`: Optional[str] (default: None)
  - [ ] `jarek_va_url`: Optional[str] (default: None)
  - [ ] `openai_api_key`: Optional[SecretStr] (default: None)
- [ ] Step 9: Add field validators
  - [ ] Validate `port` is in range 1-65535
  - [ ] Validate timeout values are positive integers
  - [ ] Validate output size limits are positive integers
  - [ ] Validate `log_level` is one of valid levels (debug, info, warning, error, critical)
  - [ ] Validate `node_env` is one of valid values (development, production, test)
- [ ] Step 10: Create singleton settings instance
  - [ ] Create module-level `settings` instance: `settings = SystemSettings()`
  - [ ] Or create a function `get_settings()` that returns a singleton
  - [ ] Ensure settings are loaded once and reused across the application
- [ ] Step 11: Add validation for required settings
  - [ ] Identify critical settings that must be present (e.g., `CURSOR_CLI_PATH` if cursor is not on PATH)
  - [ ] Add validation that raises clear errors for missing required values
  - [ ] Provide helpful error messages suggesting fixes
- [ ] Step 12: Create `.env.example` file
  - [ ] Document all environment variables with descriptions
  - [ ] Show default values in comments
  - [ ] Mark required vs optional variables
  - [ ] Include examples for complex values

### Specific Requirements

- [ ] Requirement 1: All Node.js environment variables are supported
  - Acceptance criteria: Every env var from Node.js `.env.example` has a corresponding Python setting
  - Acceptance criteria: Default values match Node.js defaults exactly
  - Acceptance criteria: Field names use snake_case but read from UPPER_CASE env vars
- [ ] Requirement 2: Type safety and validation
  - Acceptance criteria: All settings have proper type hints
  - Acceptance criteria: Invalid values raise clear validation errors
  - Acceptance criteria: Required settings fail fast with helpful messages
- [ ] Requirement 3: Settings are accessible throughout the application
  - Acceptance criteria: Settings can be imported and used in any module
  - Acceptance criteria: Settings are loaded once and reused (singleton pattern)
  - Acceptance criteria: Settings can be overridden for testing
- [ ] Requirement 4: Documentation is complete
  - Acceptance criteria: `.env.example` file exists with all variables documented
  - Acceptance criteria: README includes configuration section
  - Acceptance criteria: Code includes docstrings explaining each setting

### Error Handling and Edge Cases

- [ ] Handle case where `.env` file doesn't exist: Use environment variables only, no error
- [ ] Handle case where required setting is missing: Raise clear error with suggestion
- [ ] Handle case where setting has invalid type: Raise validation error with expected type
- [ ] Handle case where setting has invalid value (e.g., port out of range): Use default or raise error
- [ ] Handle case where multiple `.env` files exist: Document precedence (env vars > .env file)
- [ ] Handle case where SecretStr values need to be accessed: Provide `.get_secret_value()` pattern

### Testing

- [ ] Write `tests/test_system_settings.py`:
  - [ ] Test default values when no environment is set
  - [ ] Test environment variable overrides work correctly
  - [ ] Test `.env` file loading works
  - [ ] Test validation errors for invalid port values
  - [ ] Test validation errors for invalid timeout values
  - [ ] Test validation errors for invalid log levels
  - [ ] Test required settings raise errors when missing
  - [ ] Test SecretStr fields handle secrets correctly
  - [ ] Test settings singleton pattern (same instance returned)
  - [ ] Test settings can be overridden for testing
- [ ] Run `pytest tests/test_system_settings.py -v`
- [ ] Verify test coverage is >90% for system_settings.py
- [ ] **DO NOT manually test by running the server** - use automated tests instead

### Documentation

- [ ] Add docstrings to `SystemSettings` class explaining purpose and usage
- [ ] Add field descriptions using Pydantic `Field(description=...)`
- [ ] Create or update `.env.example` with all variables documented
- [ ] Update README.md with configuration section:
  - [ ] How to set environment variables
  - [ ] How to use `.env` file
  - [ ] List of all available settings with defaults
  - [ ] Required vs optional settings
- [ ] Document how to access settings in code (import pattern)

### Verification

- [ ] Verify all Node.js environment variables are represented
- [ ] Verify default values match Node.js implementation
- [ ] Verify validation works for invalid inputs
- [ ] Verify settings can be imported and used in other modules
- [ ] Verify tests pass with >90% coverage
- [ ] Verify `.env.example` is complete and accurate

## Notes

- This task is part of Phase 2: Project Setup
- **Execution Timing**: Execute after TASK-PY-002 (project skeleton), before service implementations
- **Dependencies**: 
  - TASK-PY-002: Create Python Project Skeleton (must be complete)
- **Important Considerations**: 
  - Database-backed settings (from SQLite) will be implemented in TASK-PY-006
  - This task focuses on environment-based configuration only
  - Secret values should use `SecretStr` from Pydantic to prevent accidental logging
  - Settings should be immutable after loading (use frozen config or document immutability)
  - Consider using `pydantic-settings` v2 for better validation and error messages
- **Task Independence**: This task can be completed independently after project skeleton exists
- **Current State**: No configuration module exists yet

## Related Tasks

- Previous: TASK-PY-002 (Create Python Project Skeleton)
- Next: TASK-PY-004 (Implement Structured Logging)
- Dependencies:
  - TASK-PY-002: Project skeleton must exist
- Related:
  - TASK-PY-004: Logging will use settings for log level
  - TASK-PY-006: Will add database-backed settings on top of this
  - TASK-PY-010: Cursor CLI will use cursor-related settings
  - TASK-PY-011: Conversation service will use Redis URL from settings

## Definition of Done

This task involves **CODE/FILE WRITING** - creating Python source code files and configuration.

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**User Stories**:
- As a **developer**, I need a centralized configuration module so I can access all settings with type safety
- As a **developer**, I need validated configuration so invalid settings fail fast with clear errors
- As a **developer**, I need default values matching Node.js so the Python port behaves identically
- As an **operator**, I need clear error messages so I can fix configuration issues quickly
- As a **developer**, I need documented environment variables so I know what to configure

**Automated Tests**:
- `tests/test_system_settings.py`:
  - Test all default values match Node.js defaults
  - Test environment variable overrides work
  - Test `.env` file loading
  - Test validation errors for invalid values (port, timeouts, log levels)
  - Test required settings raise errors when missing
  - Test SecretStr fields work correctly
  - Test settings singleton pattern
  - Test settings can be overridden for testing
- All tests must pass: `pytest tests/test_system_settings.py -v`
- Test coverage should be >90%: `pytest --cov=cursor_executor/services/system_settings --cov-report=term-missing`

**Commit and Push Requirements**:
- [ ] Stage all new files: `git add cursor_executor/services/system_settings.py .env.example`
- [ ] Stage updated files: `git add README.md` (if configuration section added)
- [ ] Commit with descriptive message: `git commit -m "TASK-PY-003: Implement configuration and settings module

- Add SystemSettings class with pydantic-settings
- Support all Node.js environment variables with matching defaults
- Add validation for port, timeouts, and other settings
- Create .env.example with all variables documented
- Add comprehensive tests with >90% coverage"`
- [ ] Push to origin: `git push origin <branch-name>`
- [ ] Verify commit appears in remote repository
- [ ] Verify CI/CD (if configured) runs tests successfully

**Completion Criteria**:
- [ ] `system_settings.py` module exists with all required settings
- [ ] All Node.js environment variables are supported with matching defaults
- [ ] Validation works for invalid inputs
- [ ] Tests pass with >90% coverage
- [ ] `.env.example` file exists and is complete
- [ ] Documentation is updated
- [ ] All code is committed and pushed to origin
