# TASK-4.4.1: Test POST /cursor/iterate/async auto-constructs callbackUrl when missing

**Section**: 4. HTTP Server - Cursor Execution Routes
**Subsection**: 4.4.1
**Task ID**: TASK-4.4.1
**Parent Task**: TASK-4.4

## Description

Write a test to verify that `POST /cursor/iterate/async` auto-constructs `callbackUrl` when it is missing from the request body. This ensures the async iteration endpoint can work without an explicit callback URL.

**Reference Implementation**: `virtual-assistant/cursor-runner/src/server.ts` (POST /cursor/iterate/async endpoint, callbackUrl construction)

## Current State

- POST /cursor/iterate/async endpoint exists
- callbackUrl auto-construction exists (or needs to be implemented)
- `tests/server.test.ts` exists
- Test for callbackUrl auto-construction may not exist yet

**Important**: This test verifies automatic callback URL construction.

## Checklist

### Preparation and Setup

- [ ] Review POST /cursor/iterate/async endpoint implementation
- [ ] Review how callbackUrl is constructed (buildCallbackUrl function)
- [ ] Review existing tests in `tests/server.test.ts`
- [ ] Use `createMockServer()` helper

### Implementation Steps

- [ ] Step 1: Create test structure
  - [ ] Add test: `'POST /cursor/iterate/async auto-constructs callbackUrl when missing'`
  - [ ] Use `describe` block for cursor/iterate/async endpoint tests
- [ ] Step 2: Set up mocks
  - [ ] Use `createMockServer()` helper
  - [ ] Mock `buildCallbackUrl()` function or callbackUrl construction logic
  - [ ] Mock `cursorExecution.iterate()` to track callbackUrl parameter
  - [ ] Use `supertest` to create request client
- [ ] Step 3: Test async iterate endpoint without callbackUrl
  - [ ] Make POST request to `/cursor/iterate/async` with body: `{ prompt: 'test' }` (no callbackUrl)
  - [ ] Verify callbackUrl is auto-constructed
  - [ ] Verify constructed callbackUrl is used
  - [ ] Verify response is successful
- [ ] Step 4: Verify callbackUrl construction
  - [ ] Assert callbackUrl is constructed when missing
  - [ ] Assert constructed URL format is correct
  - [ ] Assert constructed URL is used in background processing

### Specific Requirements

- [ ] Requirement 1: callbackUrl is auto-constructed when missing
  - Acceptance: callbackUrl is generated when not provided
  - Acceptance: Construction happens automatically
- [ ] Requirement 2: Constructed URL is valid
  - Acceptance: URL format is correct
  - Acceptance: URL is usable for callbacks
- [ ] Requirement 3: Test is isolated
  - Acceptance: Test doesn't affect other tests
  - Acceptance: Mocks are properly cleaned up

### Error Handling and Edge Cases

- [ ] Handle edge case 1: callbackUrl is provided
  - Verify provided callbackUrl is used (not constructed)
- [ ] Handle edge case 2: Environment variables for URL construction are missing
  - Verify fallback behavior (if applicable)

### Testing

- [ ] Write test in `tests/server.test.ts`
- [ ] Run test: `npm run test:integration`
- [ ] Verify test passes
- [ ] Verify callbackUrl construction works correctly
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`
- [ ] **DO NOT manually test by running the server** - use automated tests

### Documentation

- [ ] Add test comments explaining callbackUrl construction
- [ ] Document how callbackUrl is constructed

### Verification

- [ ] Verify test passes
- [ ] Verify callbackUrl auto-construction works correctly
- [ ] Verify no regressions in existing tests

## Notes

- This task is part of Phase 4: HTTP Server - Cursor Execution Routes
- **Execution Timing**: Must be completed after TASK-4.3.4
- **Dependencies**: TASK-4.3.4, TASK-1.1.4
- **Important Considerations**: 
  - callbackUrl should be constructed from environment variables or defaults
  - Construction should happen before background processing
- **Task Independence**: Can be done after TASK-4.3.4

## Related Tasks

- Previous: TASK-4.3.4
- Next: TASK-4.4.2
- Dependencies: TASK-4.3.4, TASK-1.1.4
- Related:
  - TASK-4.4: POST /cursor/iterate/async (parent task)

## Definition of Done

**Definition of Done**: 
1. Test is written in `tests/server.test.ts`
2. Test passes
3. callbackUrl auto-construction is verified
4. All checks pass (test, type-check, lint)
5. Code is committed to git with descriptive commit message
6. Code is pushed to origin

**User Stories**:
- As a **developer**, I want automatic callbackUrl construction so I don't have to provide it manually
- As a **client**, I want optional callbackUrl so requests are simpler

**Automated Tests**:
- Test verifies callbackUrl is auto-constructed when missing
- Test verifies constructed URL is valid
- Test passes
- All tests pass








