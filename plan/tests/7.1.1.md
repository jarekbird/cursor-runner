# TASK-7.1.1: Set up Tasks API test infrastructure with temp SQLite DB

**Section**: 7. HTTP Server - Tasks API
**Subsection**: 7.1.1
**Task ID**: TASK-7.1.1
**Parent Task**: TASK-7.1

## Description

Set up test infrastructure for Tasks API by creating `tests/tasks-api.test.ts` with `beforeAll` to create temp SQLite DB, run migrations, set `process.env.SHARED_DB_PATH`, and `afterAll` to clean up. This ensures tests have isolated database state.

**Reference Implementation**: `virtual-assistant/cursor-runner/tests/test-utils.ts` (createTempSqliteDb helper), migration runner

## Current State

- `tests/tasks-api.test.ts` may not exist yet
- `createTempSqliteDb()` helper exists (from Phase 1.1.2)
- Migration runner exists
- Test infrastructure may not be set up yet

**Important**: This establishes the foundation for all Tasks API tests.

## Checklist

### Preparation and Setup

- [ ] Review `createTempSqliteDb()` helper from Phase 1.1.2
- [ ] Review migration runner implementation
- [ ] Review existing test patterns in other test files
- [ ] Understand SQLite temp file creation

### Implementation Steps

- [ ] Step 1: Create test file structure
  - [ ] Create `tests/tasks-api.test.ts`
  - [ ] Set up basic describe block for Tasks API tests
  - [ ] Import necessary dependencies (createTempSqliteDb, etc.)
- [ ] Step 2: Set up beforeAll hook
  - [ ] Create temp SQLite DB using `createTempSqliteDb()`
  - [ ] Run migrations on temp DB
  - [ ] Set `process.env.SHARED_DB_PATH` to temp DB path
  - [ ] Store cleanup function for afterAll
- [ ] Step 3: Set up afterAll hook
  - [ ] Call cleanup function to remove temp DB
  - [ ] Unset `process.env.SHARED_DB_PATH` (if needed)
- [ ] Step 4: Create helper function
  - [ ] Create helper to reset DB state between tests (clear tables)
  - [ ] Helper should be reusable across test cases

### Specific Requirements

- [ ] Requirement 1: Temp DB is created
  - Acceptance: Temp SQLite file is created
  - Acceptance: DB path is accessible
- [ ] Requirement 2: Migrations run successfully
  - Acceptance: All migrations execute without errors
  - Acceptance: Schema is correct
- [ ] Requirement 3: Cleanup works
  - Acceptance: Temp DB is deleted after tests
  - Acceptance: No file leaks
- [ ] Requirement 4: Environment variable is set
  - Acceptance: `SHARED_DB_PATH` points to temp DB
  - Acceptance: Server can access DB

### Error Handling and Edge Cases

- [ ] Handle edge case 1: Migration failures
  - Verify error is caught and reported
- [ ] Handle edge case 2: Cleanup failures
  - Verify cleanup doesn't throw

### Testing

- [ ] Write test infrastructure in `tests/tasks-api.test.ts`
- [ ] Add basic test to verify infrastructure works
- [ ] Run test: `npm run test:integration`
- [ ] Verify temp DB is created
- [ ] Verify migrations run
- [ ] Verify cleanup works
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`
- [ ] **DO NOT manually test by running the server** - use automated tests

### Documentation

- [ ] Add comments explaining test infrastructure setup
- [ ] Document temp DB lifecycle

### Verification

- [ ] Verify test infrastructure is ready
- [ ] Verify no leaks between tests
- [ ] Verify migrations work correctly

## Notes

- This task is part of Phase 7: HTTP Server - Tasks API
- **Execution Timing**: Must be completed before all other Phase 7 tasks
- **Dependencies**: TASK-6.4.2, TASK-1.1.2
- **Important Considerations**: 
  - Temp DB should be isolated per test run
  - Migrations must run before any tests
  - Cleanup is critical to prevent file leaks
- **Task Independence**: Can be done after TASK-6.4.2

## Related Tasks

- Previous: TASK-6.4.2
- Next: TASK-7.2.1
- Dependencies: TASK-6.4.2, TASK-1.1.2
- Related:
  - TASK-7.1: Tasks API Test Infrastructure (parent task)

## Definition of Done

**Definition of Done**: 
1. Test infrastructure is set up in `tests/tasks-api.test.ts`
2. Temp DB creation works
3. Migrations run successfully
4. Cleanup works correctly
5. All checks pass (test, type-check, lint)
6. Code is committed to git with descriptive commit message
7. Code is pushed to origin

**User Stories**:
- As a **developer**, I want isolated test DB so tests don't interfere with each other
- As a **system**, I want clean test state so tests are reliable

**Automated Tests**:
- Test verifies temp DB is created
- Test verifies migrations run successfully
- Test verifies cleanup works
- Test passes
- All tests pass

