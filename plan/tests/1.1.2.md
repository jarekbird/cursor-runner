# TASK-1.1.2: Create createTempSqliteDb() Helper

**Section**: 1. Foundation & Test Infrastructure
**Subsection**: 1.1.2
**Task ID**: TASK-1.1.2
**Parent Task**: TASK-1.1

## Description

Create a reusable helper function that creates a temporary SQLite database file, runs all migrations, and returns a cleanup function. This helper will be used in integration tests that need database access without affecting the main database or requiring manual cleanup.

**Reference Implementation**: `virtual-assistant/cursor-runner/src/migrations/` (migration system)

## Current State

- Migration system exists in `src/migrations/`
- Tests that need databases currently create their own temp files or use the main DB
- No standardized helper for temp database creation exists
- `better-sqlite3` is used for database operations

**Important**: This helper depends on the migration system being functional.

## Checklist

### Preparation and Setup

- [ ] Review migration system in `src/migrations/`
- [ ] Review `better-sqlite3` API for database creation
- [ ] Review existing test files that use databases
- [ ] Understand migration runner API

### Implementation Steps

- [ ] Step 1: Create function signature
  - [ ] Add `createTempSqliteDb()` to `tests/test-utils.ts`
  - [ ] Return type: `Promise<{ db: Database, cleanup: () => Promise<void> }>`
  - [ ] Add JSDoc comments
- [ ] Step 2: Implement temp file creation
  - [ ] Use `os.tmpdir()` or `fs.mkdtempSync()` to create temp directory
  - [ ] Generate unique filename using `uuid` or timestamp
  - [ ] Create SQLite database file at temp path
- [ ] Step 3: Implement migration running
  - [ ] Import migration runner
  - [ ] Run `ensureSchemaMigrationsTable()`
  - [ ] Run `runMigrations()` with temp DB path
  - [ ] Handle migration errors gracefully
- [ ] Step 4: Implement cleanup function
  - [ ] Close database connection
  - [ ] Delete temp database file
  - [ ] Handle cleanup errors (log but don't throw)

### Specific Requirements

- [ ] Requirement 1: Temp DB must be fully migrated
  - Acceptance: All migrations are applied successfully
  - Acceptance: Schema is complete and ready for use
- [ ] Requirement 2: Cleanup must be reliable
  - Acceptance: Database file is deleted after cleanup
  - Acceptance: No file system leaks between tests
- [ ] Requirement 3: Multiple instances must not conflict
  - Acceptance: Each call creates a unique temp file
  - Acceptance: Instances don't interfere with each other

### Error Handling and Edge Cases

- [ ] Handle error case 1: Migration failures
  - Should throw descriptive error with migration details
- [ ] Handle error case 2: File system errors
  - Should handle permission errors gracefully
- [ ] Handle edge case 1: Cleanup on process exit
  - Consider cleanup in afterAll hooks

### Testing

- [ ] Write unit tests in `tests/test-utils.test.ts`
  - [ ] Test: Creates temp database file
  - [ ] Test: Runs all migrations successfully
  - [ ] Test: Returns database instance and cleanup function
  - [ ] Test: Cleanup deletes temp file
  - [ ] Test: Multiple instances create separate files
  - [ ] Test: Handles migration errors appropriately
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`

### Documentation

- [ ] Add JSDoc comments with usage examples
- [ ] Document cleanup requirements (must call cleanup in afterAll)

### Verification

- [ ] Verify temp files are created and cleaned up
- [ ] Verify migrations run successfully
- [ ] Verify no file system leaks

## Notes

- **Dependencies**: Migration system must be functional
- **Task Independence**: Can be done after 1.1.1

## Related Tasks

- Previous: TASK-1.1.1
- Next: TASK-1.1.3
- Dependencies: None
- Related: TASK-7.1, TASK-12.1 (will use this helper)

## Definition of Done

**Definition of Done**: 
1. `createTempSqliteDb()` implemented in `tests/test-utils.ts`
2. Unit tests written and passing
3. All checks pass (test, type-check, lint)
4. Code committed and pushed to origin

**User Stories**:
- As a **test developer**, I want a temp database helper so I can test database operations without affecting the main DB
- As a **test developer**, I want automatic cleanup so I don't have to manually delete temp files

**Automated Tests**:
- Tests verify temp file creation
- Tests verify migrations run
- Tests verify cleanup works
- All tests pass
