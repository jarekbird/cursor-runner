# TASK-1.1.4: Create createMockServer() Helper

**Section**: 1. Foundation & Test Infrastructure
**Subsection**: 1.1.4
**Task ID**: TASK-1.1.4
**Parent Task**: TASK-1.1

## Description

Create a helper that creates a `Server` instance with injected mocks for dependencies. This allows tests to control all server dependencies (Redis, CursorCLI, etc.) without relying on real implementations.

**Reference Implementation**: `virtual-assistant/cursor-runner/src/server.ts` (Server class)

## Current State

- `Server` class exists with constructor that accepts optional Redis client
- Tests currently create Server instances with real or partial mocks
- No standardized helper for creating mocked Server instances

## Checklist

### Preparation and Setup

- [ ] Review `Server` constructor and dependencies
- [ ] Review existing tests that create Server instances
- [ ] Understand dependency injection pattern

### Implementation Steps

- [ ] Step 1: Create function signature
  - [ ] Add `createMockServer()` to `tests/test-utils.ts`
  - [ ] Accept optional mocks for: Redis, CursorCLI, and other dependencies
  - [ ] Return configured Server instance
- [ ] Step 2: Implement dependency injection
  - [ ] Use `createMockRedisClient()` if Redis not provided
  - [ ] Use `createMockCursorCLI()` if CursorCLI not provided
  - [ ] Inject mocks into Server constructor
- [ ] Step 3: Add convenience options
  - [ ] Option to disable background workers
  - [ ] Option to set custom port
  - [ ] Return cleanup function

### Specific Requirements

- [ ] Requirement 1: All dependencies can be mocked
  - Acceptance: Can inject custom mocks for any dependency
- [ ] Requirement 2: Defaults work out of the box
  - Acceptance: Can call with no arguments and get working mock server
- [ ] Requirement 3: Cleanup is provided
  - Acceptance: Returns cleanup function to stop server

### Testing

- [ ] Write unit tests
  - [ ] Test: Creates server with default mocks
  - [ ] Test: Accepts custom mocks
  - [ ] Test: Cleanup stops server
  - [ ] Test: Can be used with supertest
- [ ] Run full test suite: `npm test`
- [ ] Run type checking: `npm run type-check`
- [ ] Run linting: `npm run lint`

### Documentation

- [ ] Add JSDoc with usage examples
- [ ] Document all options

### Verification

- [ ] Verify server can be created
- [ ] Verify mocks work correctly
- [ ] Verify cleanup works

## Notes

- **Dependencies**: TASK-1.1.1, TASK-1.1.3 (uses those helpers)
- **Task Independence**: Depends on Redis and CursorCLI mocks

## Related Tasks

- Previous: TASK-1.1.3
- Next: TASK-1.1.5
- Dependencies: TASK-1.1.1, TASK-1.1.3
- Related: All server test tasks will use this helper

## Definition of Done

**Definition of Done**: 
1. `createMockServer()` implemented
2. Unit tests written and passing
3. All checks pass
4. Code committed and pushed to origin

**User Stories**:
- As a **test developer**, I want a Server mock helper so I can test HTTP endpoints without real dependencies
- As a **test developer**, I want to inject custom mocks so I can test specific scenarios

**Automated Tests**:
- Tests verify server creation
- Tests verify mock injection
- Tests verify cleanup
- All tests pass

