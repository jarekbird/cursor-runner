# TASK-PY-005: Implement SQLite Migration Framework

**⚠️ CRITICAL: ALL IMPLEMENTATION CHANGES MUST BE MADE IN THE CURSOR-EXECUTOR APPLICATION ⚠️**

**Target Location**: All code changes, file creations, and modifications described in this task must be implemented in:
- **`python-cursor/cursor-executor/cursor-executor-back/`**

**DO NOT** make changes in:
- `python-cursor/cursor-runner/` (this is the Node.js reference implementation)
- Any other location

The `cursor-executor` application is the Python port target. All Python source code files, tests, configuration files, and documentation should be created or modified within the `cursor-executor-back` directory structure.

**Section**: 3. Data Persistence
**Subsection**: 3.1
**Task ID**: TASK-PY-005

## Description

This task implements a SQLite migration framework for `cursor-executor` that mirrors the Node.js `cursor-runner` migration system. The framework must support running migrations, rolling back migrations, checking migration status, and ensuring migrations are idempotent (safe to run multiple times).

The migration framework is critical for database schema management and must:
- Create and manage a `schema_migrations` table to track executed migrations
- Support running migrations in order based on filename timestamps
- Support rolling back migrations
- Port all Node.js migration files to Python equivalents
- Ensure migrations are idempotent (can be run multiple times safely)
- Enable WAL mode for better SQLite concurrency

This framework enables all database-backed features and must be established before implementing services that use SQLite.

**Reference Implementation**: `VirtualAssistant/cursor-runner/src/migrations/migration-runner.ts`, `VirtualAssistant/cursor-runner/src/migrations/cli.ts`, `VirtualAssistant/cursor-runner/src/migrations/files/*.ts`

## Current State

- TASK-PY-004 has been completed, providing logging infrastructure
- System settings exist (TASK-PY-003) with `shared_db_path` configuration
- No migration framework exists yet
- No database schema exists yet
- No migration CLI exists

**Important**: This task should be executed after TASK-PY-004 (logging) and before TASK-PY-006 (system settings service) which depends on the database schema.

## Checklist

### Preparation and Setup

- [ ] Review Node.js `migration-runner.ts` to understand migration framework structure
- [ ] Review Node.js `migrations/cli.ts` to understand CLI commands
- [ ] Review all Node.js migration files to understand schema structure:
  - [ ] `00000000000000_create_schema_migrations.ts`
  - [ ] `20250101000001_create_system_settings.ts`
  - [ ] `20250101000002_create_tasks.ts`
  - [ ] `20250101000003_create_git_credentials.ts`
  - [ ] `20250101000004_create_telegram_bots.ts`
- [ ] Understand Umzug library patterns (Node.js uses Umzug)
- [ ] Decide on Python migration library (custom implementation or use Alembic-like approach)

### Implementation Steps

- [ ] Step 1: Create migration framework structure
  - [ ] Create `cursor_executor/migrations/` directory
  - [ ] Create `cursor_executor/migrations/__init__.py`
  - [ ] Create `cursor_executor/migrations/runner.py` (migration runner)
  - [ ] Create `cursor_executor/migrations/cli.py` (CLI entry point)
  - [ ] Create `cursor_executor/migrations/files/` directory for migration files
- [ ] Step 2: Implement migration runner core
  - [ ] Create `MigrationRunner` class:
    - [ ] Connect to SQLite database using `shared_db_path` from settings
    - [ ] Enable WAL mode: `PRAGMA journal_mode = WAL`
    - [ ] Discover migration files from `migrations/files/` directory
    - [ ] Sort migrations by filename (timestamp-based)
    - [ ] Track executed migrations in `schema_migrations` table
    - [ ] Execute migrations in order
    - [ ] Support rollback operations
  - [ ] Implement migration discovery:
    - [ ] Scan `migrations/files/` for `.py` files
    - [ ] Filter out non-migration files (e.g., `__pycache__`, `__init__.py`)
    - [ ] Sort by filename (assumes timestamp prefix)
  - [ ] Implement migration execution:
    - [ ] Check if migration is already executed
    - [ ] Execute migration `up()` function
    - [ ] Record migration in `schema_migrations` table
    - [ ] Handle errors gracefully
  - [ ] Implement migration rollback:
    - [ ] Execute migration `down()` function
    - [ ] Remove migration from `schema_migrations` table
- [ ] Step 3: Implement schema_migrations table migration
  - [ ] Create `cursor_executor/migrations/files/00000000000000_create_schema_migrations.py`:
    - [ ] Create `schema_migrations` table with columns:
      - [ ] `name` (TEXT, PRIMARY KEY) - migration filename
      - [ ] `executed_at` (TEXT) - ISO timestamp
    - [ ] Implement `up()` function to create table
    - [ ] Implement `down()` function to drop table (if needed)
    - [ ] Make migration idempotent (check if table exists)
- [ ] Step 4: Port system settings migration
  - [ ] Create `cursor_executor/migrations/files/20250101000001_create_system_settings.py`:
    - [ ] Create `system_settings` table with columns matching Node.js:
      - [ ] `key` (TEXT, PRIMARY KEY)
      - [ ] `value` (TEXT)
      - [ ] `created_at` (TEXT)
      - [ ] `updated_at` (TEXT)
    - [ ] Implement `up()` and `down()` functions
    - [ ] Make idempotent
- [ ] Step 5: Port tasks migration
  - [ ] Create `cursor_executor/migrations/files/20250101000002_create_tasks.py`:
    - [ ] Create `tasks` table with columns matching Node.js
    - [ ] Implement `up()` and `down()` functions
    - [ ] Make idempotent
- [ ] Step 6: Port git credentials migration
  - [ ] Create `cursor_executor/migrations/files/20250101000003_create_git_credentials.py`:
    - [ ] Create `git_credentials` table with columns matching Node.js
    - [ ] Implement `up()` and `down()` functions
    - [ ] Make idempotent
- [ ] Step 7: Port telegram bots migration
  - [ ] Create `cursor_executor/migrations/files/20250101000004_create_telegram_bots.py`:
    - [ ] Create `telegram_bots` table with columns matching Node.js
    - [ ] Implement `up()` and `down()` functions
    - [ ] Make idempotent
- [ ] Step 8: Implement migration CLI
  - [ ] Create `cursor_executor/migrations/cli.py`:
    - [ ] Support `migrate` command: Run all pending migrations
    - [ ] Support `rollback` command: Rollback last migration
    - [ ] Support `status` command: Show migration status
    - [ ] Support `list` command: List all migrations
    - [ ] Use argparse or click for CLI
    - [ ] Add entry point in `pyproject.toml` or create `migrate.py` script
- [ ] Step 9: Ensure idempotency
  - [ ] All migrations check if objects exist before creating
  - [ ] Use `IF NOT EXISTS` for table creation
  - [ ] Use `IF EXISTS` for drops
  - [ ] Test running migrations twice

### Specific Requirements

- [ ] Requirement 1: Migration framework matches Node.js behavior
  - Acceptance criteria: Migrations run in timestamp order
  - Acceptance criteria: Executed migrations are tracked in `schema_migrations` table
  - Acceptance criteria: Rollback functionality works
  - Acceptance criteria: Status command shows correct state
- [ ] Requirement 2: All Node.js migrations are ported
  - Acceptance criteria: All 5 migration files exist in Python
  - Acceptance criteria: Table schemas match Node.js exactly
  - Acceptance criteria: Column types and constraints match
- [ ] Requirement 3: Migrations are idempotent
  - Acceptance criteria: Running migrations twice produces no errors
  - Acceptance criteria: Schema is correct after second run
  - Acceptance criteria: No duplicate tables or constraints
- [ ] Requirement 4: CLI is functional
  - Acceptance criteria: `migrate` command runs all pending migrations
  - Acceptance criteria: `status` command shows migration status
  - Acceptance criteria: `rollback` command rolls back last migration
  - Acceptance criteria: CLI provides clear error messages

### Error Handling and Edge Cases

- [ ] Handle case where database file doesn't exist: Create directory and file
- [ ] Handle case where migration file is malformed: Log error and skip
- [ ] Handle case where migration fails mid-execution: Rollback if possible, log error
- [ ] Handle case where schema_migrations table doesn't exist: Run initial migration first
- [ ] Handle case where migration is partially applied: Detect and handle gracefully
- [ ] Handle case where database is locked: Retry with backoff
- [ ] Handle case where migration file is missing: Log warning, continue

### Testing

- [ ] Write `tests/test_migrations.py`:
  - [ ] Test migration runner discovers migration files correctly
  - [ ] Test migrations run in correct order (timestamp-based)
  - [ ] Test migrations are idempotent (run twice, no errors)
  - [ ] Test schema_migrations table is created correctly
  - [ ] Test all tables are created with correct schema
  - [ ] Test rollback functionality works
  - [ ] Test status command shows correct state
  - [ ] Test error handling for malformed migrations
  - [ ] Test error handling for missing database
  - [ ] Test WAL mode is enabled
  - [ ] Use temporary SQLite database for tests
- [ ] Run `pytest tests/test_migrations.py -v`
- [ ] Verify test coverage is >85% for migration framework
- [ ] **DO NOT manually test by running migrations on production DB** - use test database

### Documentation

- [ ] Add docstrings to migration runner classes and functions
- [ ] Document migration file format and structure
- [ ] Document how to create new migrations
- [ ] Document CLI usage in README
- [ ] Document migration naming convention (timestamp prefix)
- [ ] Document idempotency requirements for migrations

### Verification

- [ ] Verify migration framework can discover and run migrations
- [ ] Verify all Node.js migrations are ported correctly
- [ ] Verify migrations are idempotent
- [ ] Verify CLI commands work correctly
- [ ] Verify tests pass with >85% coverage
- [ ] Verify database schema matches Node.js after migrations

## Notes

- This task is part of Phase 3: Data Persistence
- **Execution Timing**: Execute after TASK-PY-004 (logging), before TASK-PY-006 (system settings service)
- **Dependencies**: 
  - TASK-PY-003: System settings needed for `shared_db_path`
  - TASK-PY-004: Logging needed for migration logging
- **Important Considerations**: 
  - Python's `sqlite3` module is sufficient (no need for external library)
  - Consider using a simple custom migration framework vs Alembic (Alembic may be overkill)
  - Migration files should be simple Python modules with `up()` and `down()` functions
  - WAL mode is important for SQLite concurrency
  - Migration filenames should use timestamp prefix for ordering
- **Task Independence**: This task can be completed independently after settings and logging exist
- **Current State**: No migration framework exists yet

## Related Tasks

- Previous: TASK-PY-004 (Implement Structured Logging)
- Next: TASK-PY-006 (Implement System Settings & Task Services)
- Dependencies:
  - TASK-PY-003: System settings for database path
  - TASK-PY-004: Logging for migration operations
- Related:
  - TASK-PY-006: Will use the database schema created here
  - All future database-backed services depend on this

## Definition of Done

This task involves **CODE/FILE WRITING** - creating Python source code files for migrations.

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**User Stories**:
- As a **developer**, I need a migration framework so I can manage database schema changes
- As a **developer**, I need idempotent migrations so I can run them safely multiple times
- As an **operator**, I need migration CLI commands so I can manage database schema
- As a **developer**, I need ported migrations so the Python database schema matches Node.js

**Automated Tests**:
- `tests/test_migrations.py`:
  - Test migration discovery and ordering
  - Test migrations run successfully
  - Test migrations are idempotent (run twice, no errors)
  - Test schema_migrations table creation
  - Test all table schemas match Node.js
  - Test rollback functionality
  - Test status command
  - Test error handling (malformed migrations, missing DB, etc.)
  - Test WAL mode is enabled
- All tests must pass: `pytest tests/test_migrations.py -v`
- Test coverage should be >85%: `pytest --cov=cursor_executor/migrations --cov-report=term-missing`

**Commit and Push Requirements**:
- [ ] Stage all new files: `git add cursor_executor/migrations/`
- [ ] Commit with descriptive message: `git commit -m "TASK-PY-005: Implement SQLite migration framework

- Add migration runner with discover, execute, and rollback
- Port all 5 Node.js migrations to Python
- Add migration CLI (migrate, rollback, status, list)
- Ensure migrations are idempotent
- Add comprehensive tests with >85% coverage"`
- [ ] Push to origin: `git push origin <branch-name>`
- [ ] Verify commit appears in remote repository
- [ ] Verify CI/CD (if configured) runs tests successfully

**Completion Criteria**:
- [ ] Migration framework exists and works
- [ ] All 5 Node.js migrations are ported to Python
- [ ] Migrations are idempotent
- [ ] CLI commands work correctly
- [ ] Tests pass with >85% coverage
- [ ] Database schema matches Node.js after migrations
- [ ] All code is committed and pushed to origin
