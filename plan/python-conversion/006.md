# TASK-PY-006: Implement System Settings & Task Services (SQLite)

**⚠️ CRITICAL: ALL IMPLEMENTATION CHANGES MUST BE MADE IN THE CURSOR-EXECUTOR APPLICATION ⚠️**

**Target Location**: All code changes, file creations, and modifications described in this task must be implemented in:
- **`python-cursor/cursor-executor/cursor-executor-back/`**

**DO NOT** make changes in:
- `python-cursor/cursor-runner/` (this is the Node.js reference implementation)
- Any other location

The `cursor-executor` application is the Python port target. All Python source code files, tests, configuration files, and documentation should be created or modified within the `cursor-executor-back` directory structure.

**Section**: 3. Data Persistence
**Subsection**: 3.2
**Task ID**: TASK-PY-006

## Description

This task implements the system settings service and task service that interact with the SQLite database created by migrations in TASK-PY-005. These services provide database-backed configuration and task management functionality, mirroring the Node.js `cursor-runner` behavior.

The system settings service allows reading and writing system settings to the database, with environment variable fallbacks for certain settings (like debug flags). The task service provides CRUD operations for tasks with status filtering and ordering rules.

Both services must:
- Use the SQLite database schema created by migrations
- Handle database connection errors gracefully
- Provide type-safe interfaces
- Match Node.js behavior exactly

**Reference Implementation**: `VirtualAssistant/cursor-runner/src/system-settings.ts`, `VirtualAssistant/cursor-runner/src/task-service.ts`

## Current State

- TASK-PY-005 has been completed, providing the migration framework and database schema
- System settings table exists in database schema
- Tasks table exists in database schema
- No services exist to interact with these tables yet
- Environment-based settings exist (TASK-PY-003) but database-backed settings don't

**Important**: This task should be executed after TASK-PY-005 (migrations) so the database schema exists, and before services that need database-backed settings.

## Checklist

### Preparation and Setup

- [ ] Review Node.js `system-settings.ts` to understand database-backed settings behavior
- [ ] Review Node.js `task-service.ts` to understand task CRUD operations
- [ ] Review database schema from migrations:
  - [ ] `system_settings` table structure
  - [ ] `tasks` table structure
- [ ] Understand how environment fallbacks work in Node.js
- [ ] Review task status values and ordering rules

### Implementation Steps

- [ ] Step 1: Create database connection helper
  - [ ] Create `cursor_executor/services/db.py` (or add to existing module):
    - [ ] Function to get database connection using `shared_db_path` from settings
    - [ ] Enable WAL mode
    - [ ] Handle connection errors gracefully
    - [ ] Provide connection context manager
- [ ] Step 2: Implement system settings service
  - [ ] Create `cursor_executor/services/system_settings_service.py`:
    - [ ] `get_setting(key: str) -> Optional[str]`: Read setting from database
    - [ ] `set_setting(key: str, value: str) -> None`: Write setting to database
    - [ ] `delete_setting(key: str) -> None`: Delete setting from database
    - [ ] `is_system_setting_enabled(setting_name: str) -> bool`:
      - [ ] Check database for setting value
      - [ ] Fall back to environment variable (e.g., `DEBUG`)
      - [ ] Return boolean (true if enabled, false otherwise)
    - [ ] Handle database errors gracefully (log, return defaults)
    - [ ] Use proper SQL parameterization to prevent injection
- [ ] Step 3: Implement task service
  - [ ] Create `cursor_executor/services/task_service.py`:
    - [ ] `create_task(data: dict) -> dict`: Create new task
      - [ ] Generate ID if not provided
      - [ ] Set timestamps (created_at, updated_at)
      - [ ] Insert into database
      - [ ] Return created task
    - [ ] `get_task(task_id: str) -> Optional[dict]`: Get task by ID
    - [ ] `update_task(task_id: str, data: dict) -> Optional[dict]`: Update task
      - [ ] Update updated_at timestamp
      - [ ] Return updated task
    - [ ] `delete_task(task_id: str) -> bool`: Delete task
    - [ ] `list_tasks(status: Optional[str] = None, limit: Optional[int] = None, offset: Optional[int] = None) -> List[dict]`:
      - [ ] Filter by status if provided
      - [ ] Order by created_at descending (or as per Node.js rules)
      - [ ] Support pagination with limit/offset
      - [ ] Return list of tasks
    - [ ] Handle status values consistently (match Node.js status labels)
    - [ ] Use proper SQL parameterization
- [ ] Step 4: Add error handling
  - [ ] Handle database connection errors
  - [ ] Handle SQL errors (constraint violations, etc.)
  - [ ] Log errors appropriately
  - [ ] Return None or empty results on errors (don't crash)
- [ ] Step 5: Add type hints and validation
  - [ ] Use Pydantic models for task data structures
  - [ ] Validate task status values
  - [ ] Validate required fields
  - [ ] Type hints for all functions

### Specific Requirements

- [ ] Requirement 1: System settings service matches Node.js behavior
  - Acceptance criteria: `is_system_setting_enabled` checks database first, then env
  - Acceptance criteria: Settings can be read and written to database
  - Acceptance criteria: Database errors don't crash the service
- [ ] Requirement 2: Task service matches Node.js behavior
  - Acceptance criteria: CRUD operations work correctly
  - Acceptance criteria: Status filtering works
  - Acceptance criteria: Ordering matches Node.js (created_at descending)
  - Acceptance criteria: Pagination works with limit/offset
- [ ] Requirement 3: Error handling is robust
  - Acceptance criteria: Database connection errors are handled gracefully
  - Acceptance criteria: SQL errors are logged and don't crash
  - Acceptance criteria: Services return None/empty on errors
- [ ] Requirement 4: Type safety
  - Acceptance criteria: All functions have type hints
  - Acceptance criteria: Pydantic models validate task data
  - Acceptance criteria: Status values are validated

### Error Handling and Edge Cases

- [ ] Handle case where database doesn't exist: Log error, return defaults
- [ ] Handle case where table doesn't exist: Log error, return defaults
- [ ] Handle case where database is locked: Retry with backoff
- [ ] Handle case where task ID doesn't exist: Return None
- [ ] Handle case where setting key doesn't exist: Return None
- [ ] Handle case where status filter is invalid: Return empty list or raise error
- [ ] Handle case where pagination parameters are invalid: Use defaults

### Testing

- [ ] Write `tests/test_system_settings_service.py`:
  - [ ] Test reading setting from database
  - [ ] Test writing setting to database
  - [ ] Test deleting setting
  - [ ] Test `is_system_setting_enabled` with database value
  - [ ] Test `is_system_setting_enabled` with environment fallback
  - [ ] Test error handling when database is unavailable
  - [ ] Test error handling when table doesn't exist
  - [ ] Use temporary SQLite database for tests
- [ ] Write `tests/test_task_service.py`:
  - [ ] Test creating task
  - [ ] Test getting task by ID
  - [ ] Test updating task
  - [ ] Test deleting task
  - [ ] Test listing tasks with status filter
  - [ ] Test listing tasks with pagination
  - [ ] Test ordering (created_at descending)
  - [ ] Test error handling when database is unavailable
  - [ ] Test error handling for invalid task ID
  - [ ] Use temporary SQLite database for tests
- [ ] Run `pytest tests/test_system_settings_service.py tests/test_task_service.py -v`
- [ ] Verify test coverage is >85% for both services
- [ ] **DO NOT manually test by running the server** - use automated tests instead

### Documentation

- [ ] Add docstrings to all service functions
- [ ] Document task status values and their meanings
- [ ] Document how system settings interact with environment variables
- [ ] Document error handling behavior
- [ ] Update README with service usage examples

### Verification

- [ ] Verify system settings service works with database
- [ ] Verify environment fallback works correctly
- [ ] Verify task service CRUD operations work
- [ ] Verify status filtering and ordering work
- [ ] Verify error handling is robust
- [ ] Verify tests pass with >85% coverage

## Notes

- This task is part of Phase 3: Data Persistence
- **Execution Timing**: Execute after TASK-PY-005 (migrations), before services that need database-backed settings
- **Dependencies**: 
  - TASK-PY-005: SQLite Migration Framework (must be complete for database schema)
- **Important Considerations**: 
  - Database connection should be managed carefully (use context managers)
  - WAL mode should be enabled for better concurrency
  - SQL parameterization is critical for security
  - Services should degrade gracefully when database is unavailable
  - Task status values must match Node.js exactly
- **Task Independence**: This task can be completed independently after migrations exist
- **Current State**: Database schema exists but no services interact with it yet

## Related Tasks

- Previous: TASK-PY-005 (Implement SQLite Migration Framework)
- Next: TASK-PY-007 (Implement Filesystem & File Tree Services)
- Dependencies:
  - TASK-PY-005: Database schema must exist
- Related:
  - TASK-PY-003: Environment-based settings complement database-backed settings
  - TASK-PY-014: HTTP API will use these services

## Definition of Done

This task involves **CODE/FILE WRITING** - creating Python source code files.

**Description**: Tasks that involve writing, creating, modifying, or implementing SOURCE CODE FILES that need to be committed to git.

**Definition of Done**: "A Pull Request was created OR code was pushed to origin with the task complete"

**User Stories**:
- As a **developer**, I need database-backed system settings so I can configure the system dynamically
- As a **developer**, I need task service so I can manage tasks with status and ordering
- As a **developer**, I need environment fallbacks so settings work even if database is unavailable
- As an **operator**, I need robust error handling so the service doesn't crash on database errors

**Automated Tests**:
- `tests/test_system_settings_service.py`:
  - Test CRUD operations for settings
  - Test `is_system_setting_enabled` with database and env fallback
  - Test error handling (database unavailable, table missing)
- `tests/test_task_service.py`:
  - Test CRUD operations for tasks
  - Test status filtering
  - Test pagination and ordering
  - Test error handling (invalid IDs, database unavailable)
- All tests must pass: `pytest tests/test_system_settings_service.py tests/test_task_service.py -v`
- Test coverage should be >85%: `pytest --cov=cursor_executor/services/system_settings_service --cov=cursor_executor/services/task_service --cov-report=term-missing`

**Commit and Push Requirements**:
- [ ] Stage all new files: `git add cursor_executor/services/system_settings_service.py cursor_executor/services/task_service.py cursor_executor/services/db.py`
- [ ] Commit with descriptive message: `git commit -m "TASK-PY-006: Implement system settings and task services

- Add system_settings_service with database-backed settings and env fallback
- Add task_service with CRUD, status filtering, and pagination
- Add database connection helper with error handling
- Add comprehensive tests with >85% coverage"`
- [ ] Push to origin: `git push origin <branch-name>`
- [ ] Verify commit appears in remote repository
- [ ] Verify CI/CD (if configured) runs tests successfully

**Completion Criteria**:
- [ ] System settings service exists and works with database
- [ ] Task service exists with full CRUD operations
- [ ] Environment fallback works for system settings
- [ ] Error handling is robust
- [ ] Tests pass with >85% coverage
- [ ] All code is committed and pushed to origin
